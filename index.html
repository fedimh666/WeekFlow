<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeekFlow Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Offline font fallbacks ‚Äî app stays beautiful even without internet */
@font-face {
  font-family: 'Fraunces';
  font-style: normal;
  font-weight: 900;
  src: local('Georgia'), local('Times New Roman');
  size-adjust: 95%;
}
body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
</style>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
  <meta name="theme-color" content="#1A1208">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WeekFlow">
  <meta name="mobile-web-app-capable" content="yes">
<style>
:root {
  --bg:#F7F3EE; --white:#FFFFFF; --ink:#1A1208; --muted:#9A8F7E; --border:#E4DDD3;
  --mon:#FF6B6B; --tue:#FF9F43; --wed:#f0c040; --thu:#26de81;
  --fri:#45aaf2; --sat:#a29bfe; --sun:#fd79a8;
  --radius:14px;
  --shadow:0 2px 20px rgba(26,18,8,0.08);
  --shadow-lg:0 8px 40px rgba(26,18,8,0.14);
}
[data-theme="dark"] {
  --bg:#0F0F0F; --white:#1C1C1E; --ink:#F0EDE8; --muted:#6B6560; --border:#2C2C2E;
  --shadow:0 2px 20px rgba(0,0,0,0.4);
  --shadow-lg:0 8px 40px rgba(0,0,0,0.6);
}
[data-theme="dark"] body::before{opacity:.15;}
[data-theme="dark"] .topbar{background:rgba(15,15,15,.95);}
[data-theme="dark"] .auth-box{background:#1C1C1E;}
[data-theme="dark"] .cell-task{background:#252525;border-color:#2C2C2E;}
[data-theme="dark"] .table-wrap{background:#1C1C1E;}
[data-theme="dark"] .add-task-btn:hover{background:#252525;}
[data-theme="dark"] .mobile-nav{background:rgba(15,15,15,.97);}
[data-theme="dark"] #loading{background:#0F0F0F;}
[data-theme="dark"] .modal .modal{background:#1C1C1E;}
[data-theme="dark"] .modal-overlay .modal{background:#1C1C1E;}
[data-theme="dark"] .ios-modal-box{background:#1C1C1E;}
[data-theme="dark"] .week-row{background:#252525;}
[data-theme="dark"] .tmpl-item{background:#252525;}
[data-theme="dark"] .pomo-settings{background:#1C1C1E;}
[data-theme="dark"] .quote-card{background:#1a1a1a;}
[data-theme="dark"] .sum-card,.dash-card,.dash-wide,.notif-card,.tmpl-card,.pomo-stat{background:#1C1C1E;}
[data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{background:#252525!important;color:var(--ink)!important;border-color:var(--border)!important;}
[data-theme="dark"] .auth-field input{background:#252525;}
[data-theme="dark"] .best-day-card{background:linear-gradient(135deg,#1C1C1E,#252525);}
[data-theme="dark"] .today-col .day-header{background:#2a2a2a;}

/* Dark mode toggle button */
.dark-toggle{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.dark-toggle:hover{background:var(--ink);color:var(--bg);}

/* Search bar */
.search-wrap{position:relative;flex-shrink:0;display:flex;align-items:center;gap:6px;}
.search-input{width:0;padding:0;border:1.5px solid transparent;border-radius:99px;background:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:all .3s ease;overflow:hidden;}
.search-input.open{width:190px;padding:7px 14px;}
.search-icon{display:none;}
.search-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.search-btn:hover{background:var(--ink);color:#fff;}

/* Search results dropdown */
.search-results{position:absolute;top:42px;right:0;width:320px;background:var(--white);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-lg);z-index:300;max-height:360px;overflow-y:auto;display:none;}
.search-results.show{display:block;}
.search-result-item{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;}
.search-result-item:last-child{border-bottom:none;}
.search-result-item:hover{background:var(--bg);}
.sr-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.sr-text{font-size:13px;font-weight:600;color:var(--ink);flex:1;}
.sr-meta{font-size:10px;color:var(--muted);}
.search-empty{padding:24px;text-align:center;color:var(--muted);font-size:13px;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.4;}

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
#auth-screen{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1A1208,#2d2015,#1a1208);}
#auth-screen.hidden{display:none;}
.auth-box{background:var(--white);border-radius:24px;padding:48px 44px;width:100%;max-width:440px;margin:20px;box-shadow:0 32px 80px rgba(0,0,0,.4);animation:authIn .5s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes authIn{from{opacity:0;transform:scale(.9) translateY(30px);}to{opacity:1;transform:scale(1) translateY(0);}}
.auth-logo{font-family:'Fraunces',serif;font-weight:900;font-size:34px;margin-bottom:4px;}
.auth-logo span{background:linear-gradient(135deg,#FF6B6B,#FF9F43);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.auth-badge{display:inline-block;background:#f0f0ff;border:1px solid #ddd;border-radius:99px;font-size:10px;font-weight:700;letter-spacing:.5px;padding:3px 10px;color:#666;margin-bottom:20px;}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px;}
.auth-tab{flex:1;padding:10px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;}
.auth-tab.active{background:var(--ink);color:#fff;}
.auth-field{margin-bottom:13px;}
.auth-field label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:5px;font-weight:600;}
.auth-field input{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;color:var(--ink);outline:none;transition:border-color .2s;}
.auth-field input:focus{border-color:var(--ink);}
.auth-btn-primary{width:100%;padding:14px;border-radius:10px;border:none;background:var(--ink);color:#fff;font-family:'Fraunces',serif;font-weight:700;font-size:16px;cursor:pointer;transition:opacity .2s,transform .15s;margin-bottom:12px;}
.auth-btn-primary:hover{opacity:.88;transform:translateY(-1px);}
.auth-divider{display:flex;align-items:center;gap:12px;margin:14px 0;font-size:10px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.auth-google{width:100%;padding:12px;border-radius:10px;border:1.5px solid var(--border);background:var(--white);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--ink);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px;}
.auth-google:hover{background:var(--bg);}
.auth-google svg{width:18px;height:18px;}
.auth-error{background:#fff0f0;border:1px solid #ffd0d0;border-radius:8px;padding:10px 14px;font-size:13px;color:#cc3333;margin-bottom:12px;display:none;}
.auth-error.show{display:block;}

/* ‚ïê‚ïê LOADING ‚ïê‚ïê */
#loading{position:fixed;inset:0;z-index:150;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
#loading.hidden{display:none;}
.loader{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--ink);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loader-text{font-size:12px;color:var(--muted);letter-spacing:1px;}

/* ‚ïê‚ïê APP SHELL ‚ïê‚ïê */
#app{position:relative;z-index:1;display:none;}
#app.visible{display:block;}

/* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
.topbar{position:sticky;top:0;z-index:50;background:rgba(247,243,238,.94);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:62px;gap:16px;}
.tb-logo{font-family:'Fraunces',serif;font-weight:900;font-size:21px;flex-shrink:0;}
.tb-logo span{background:linear-gradient(135deg,#FF6B6B,#FF9F43);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.tb-pro{font-size:9px;font-weight:700;letter-spacing:.8px;background:linear-gradient(135deg,#FF6B6B,#FF9F43);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-left:4px;vertical-align:super;}

/* Nav tabs */
.tb-tabs{display:flex;gap:2px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:3px;}
.tb-tab{padding:7px 16px;border-radius:7px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.tb-tab.active{background:var(--white);color:var(--ink);box-shadow:var(--shadow);}
.tb-tab:hover:not(.active){color:var(--ink);}

/* Week nav */
.tb-week-nav{display:flex;align-items:center;gap:8px;background:var(--white);border:1px solid var(--border);border-radius:99px;padding:7px 14px;box-shadow:var(--shadow);}
.tb-nav-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.tb-nav-btn:hover{background:var(--ink);color:#fff;}
.tb-week-label{font-family:'Fraunces',serif;font-weight:700;font-size:13px;min-width:190px;text-align:center;}
.tb-today-btn{background:var(--ink);color:#fff;border:none;border-radius:99px;padding:5px 14px;font-size:11px;font-weight:600;cursor:pointer;transition:opacity .2s;font-family:'Plus Jakarta Sans',sans-serif;}
.tb-today-btn:hover{opacity:.8;}

.tb-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.tb-notif-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;position:relative;transition:all .2s;}
.tb-notif-btn:hover{background:var(--ink);color:#fff;}
.notif-badge{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#FF6B6B;border-radius:50%;display:none;}
.notif-badge.show{display:block;}
.tb-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#FF6B6B,#FF9F43);display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-weight:900;font-size:14px;color:#fff;overflow:hidden;flex-shrink:0;}
.tb-avatar img{width:100%;height:100%;object-fit:cover;}
.tb-name{font-size:12px;font-weight:600;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.saving-dot{width:7px;height:7px;border-radius:50%;background:#26de81;animation:blink 1.2s ease infinite;}
.saving-dot.error{background:#FF6B6B;animation:none;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}
.tb-logout{background:transparent;border:1px solid var(--border);border-radius:8px;padding:5px 11px;font-size:11px;color:var(--muted);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .2s;}
.tb-logout:hover{border-color:#FF6B6B;color:#FF6B6B;}

/* ‚ïê‚ïê PAGES ‚ïê‚ïê */
.page{display:none;max-width:1400px;margin:0 auto;padding:24px 24px 80px;}
.page.active{display:block;}

/* ‚ïê‚ïê PLANNER PAGE ‚ïê‚ïê */
.summary{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;animation:fadeUp .4s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
.sum-card{background:var(--white);border-radius:var(--radius);padding:15px 18px;border:1px solid var(--border);box-shadow:var(--shadow);flex:1;min-width:100px;}
.sum-label{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-weight:600;}
.sum-value{font-family:'Fraunces',serif;font-size:26px;font-weight:900;color:var(--ink);}
.sum-sub{font-size:10px;color:var(--muted);}
.progress-card{flex:3;background:var(--white);border-radius:var(--radius);padding:15px 20px;border:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column;justify-content:center;gap:7px;}
.progress-row{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);}
.progress-row strong{font-family:'Fraunces',serif;color:var(--ink);font-size:13px;}
.prog-track{height:8px;background:var(--bg);border-radius:99px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,#FF6B6B,#FF9F43,#f0c040);border-radius:99px;transition:width .7s cubic-bezier(.4,0,.2,1);}

/* Motivational banner */
.motiv-banner{display:none;align-items:center;gap:12px;background:linear-gradient(135deg,rgba(38,222,129,.12),rgba(69,170,242,.08));border:1px solid rgba(38,222,129,.25);border-radius:var(--radius);padding:14px 20px;margin-bottom:16px;animation:fadeUp .4s ease both;}
.motiv-banner.show{display:flex;}
.motiv-emoji{font-size:28px;}
.motiv-text{font-size:13px;font-weight:600;color:var(--ink);}
.motiv-sub{font-size:11px;color:var(--muted);}
.motiv-close{margin-left:auto;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;}

/* Template bar */
.template-bar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.template-bar-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.template-chip{padding:6px 14px;border-radius:99px;border:1.5px solid var(--border);background:var(--white);font-size:12px;font-weight:600;color:var(--ink);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.template-chip:hover{border-color:var(--ink);background:var(--bg);}
.template-chip.save-btn{background:var(--ink);color:#fff;border-color:var(--ink);}
.template-chip.save-btn:hover{opacity:.85;}

/* Table */
.table-wrap{background:var(--white);border-radius:20px;border:1px solid var(--border);box-shadow:var(--shadow-lg);overflow:hidden;animation:fadeUp .4s ease .1s both;}
.week-table{width:100%;border-collapse:collapse;}
.week-table thead tr th{padding:0;border-right:1px solid var(--border);width:calc(100%/7);}
.week-table thead tr th:last-child{border-right:none;}
.day-header{padding:14px 12px 12px;text-align:center;}
.day-name{font-family:'Fraunces',serif;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.day-date{font-family:'Fraunces',serif;font-weight:900;font-size:24px;line-height:1;margin-bottom:3px;}
.day-month{font-size:9px;color:var(--muted);font-weight:500;letter-spacing:.4px;}
.day-count{font-size:9px;padding:2px 7px;border-radius:99px;font-weight:700;display:inline-block;margin-top:2px;}
.col-mon .day-header{border-bottom:3px solid var(--mon);} .col-tue .day-header{border-bottom:3px solid var(--tue);}
.col-wed .day-header{border-bottom:3px solid var(--wed);} .col-thu .day-header{border-bottom:3px solid var(--thu);}
.col-fri .day-header{border-bottom:3px solid var(--fri);} .col-sat .day-header{border-bottom:3px solid var(--sat);}
.col-sun .day-header{border-bottom:3px solid var(--sun);}
.col-mon .day-name{color:var(--mon);} .col-tue .day-name{color:var(--tue);} .col-wed .day-name{color:var(--wed);}
.col-thu .day-name{color:var(--thu);} .col-fri .day-name{color:var(--fri);} .col-sat .day-name{color:var(--sat);}
.col-sun .day-name{color:var(--sun);}
.col-mon .day-date{color:var(--mon);} .col-tue .day-date{color:var(--tue);} .col-wed .day-date{color:var(--wed);}
.col-thu .day-date{color:var(--thu);} .col-fri .day-date{color:var(--fri);} .col-sat .day-date{color:var(--sat);}
.col-sun .day-date{color:var(--sun);}
.col-mon .day-count{background:rgba(255,107,107,.12);color:var(--mon);} .col-tue .day-count{background:rgba(255,159,67,.12);color:var(--tue);}
.col-wed .day-count{background:rgba(240,192,64,.18);color:#b8900a;} .col-thu .day-count{background:rgba(38,222,129,.12);color:#20bf6b;}
.col-fri .day-count{background:rgba(69,170,242,.12);color:var(--fri);} .col-sat .day-count{background:rgba(162,155,254,.12);color:var(--sat);}
.col-sun .day-count{background:rgba(253,121,168,.12);color:var(--sun);}
.today-col .day-header{background:var(--ink);}
.today-col .day-name,.today-col .day-date,.today-col .day-month{color:#fff!important;}
.today-col .day-count{background:rgba(255,255,255,.18);color:#fff;}

.week-table tbody tr td{vertical-align:top;border-right:1px solid var(--border);border-top:1px solid var(--border);padding:10px 8px;}
.week-table tbody tr td:last-child{border-right:none;}
.day-cell{min-height:260px;display:flex;flex-direction:column;gap:5px;}

/* Drag over highlight */
.day-cell.drag-over{background:rgba(69,170,242,.06);border-radius:10px;outline:2px dashed rgba(69,170,242,.4);}

/* Task card */
.cell-task{display:flex;align-items:flex-start;gap:7px;padding:8px 9px;border-radius:9px;background:var(--bg);border:1px solid var(--border);transition:transform .15s,box-shadow .15s,opacity .2s;animation:taskPop .2s ease both;position:relative;overflow:hidden;cursor:grab;}
.cell-task:active{cursor:grabbing;}
.cell-task::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;}
.cell-task.p-high::before{background:#FF6B6B;} .cell-task.p-medium::before{background:#FF9F43;} .cell-task.p-low::before{background:#26de81;}
.cell-task:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1);}
.cell-task.done-task{opacity:.4;} .cell-task.done-task .ct-text{text-decoration:line-through;color:var(--muted);}
.cell-task.dragging{opacity:.35;transform:scale(.97);}
@keyframes taskPop{from{opacity:0;transform:scale(.94) translateY(4px);}to{opacity:1;transform:scale(1) translateY(0);}}
.ct-check{width:17px;height:17px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;flex-shrink:0;margin-top:1px;transition:all .15s;font-size:9px;display:flex;align-items:center;justify-content:center;}
.ct-check:hover{border-color:#FF6B6B;background:rgba(255,107,107,.1);}
.cell-task.done-task .ct-check{background:#26de81;border-color:#26de81;color:#fff;}
.ct-body{flex:1;min-width:0;}
.ct-text{font-size:12px;font-weight:600;color:var(--ink);line-height:1.3;word-break:break-word;}
.ct-meta{display:flex;gap:4px;margin-top:3px;flex-wrap:wrap;align-items:center;}
.ct-tag{font-size:9px;padding:1px 5px;border-radius:99px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
.ct-tag.work{background:rgba(69,170,242,.15);color:#2d98da;} .ct-tag.personal{background:rgba(38,222,129,.12);color:#20bf6b;}
.ct-tag.shopping{background:rgba(254,202,87,.2);color:#e0a800;} .ct-tag.health{background:rgba(253,121,168,.15);color:#e84393;}
.ct-tag.custom{background:rgba(162,155,254,.15);color:#6c5ce7;}
/* custom category input row */
.custom-cat-row{display:flex;gap:8px;align-items:center;margin-top:8px;display:none;}
.custom-cat-row.show{display:flex;}
.custom-cat-input{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;}
.custom-cat-input:focus{border-color:#a29bfe;}
.custom-cat-emoji{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:8px 10px;font-size:16px;cursor:pointer;outline:none;width:50px;text-align:center;}
/* emoji picker */
.emoji-picker{display:none;flex-wrap:wrap;gap:4px;padding:10px;background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-lg);position:absolute;z-index:500;width:220px;}
.emoji-picker.show{display:flex;}
.emoji-opt{font-size:20px;cursor:pointer;padding:4px;border-radius:6px;transition:background .15s;}
.emoji-opt:hover{background:var(--bg);}
.ct-del{width:18px;height:18px;border-radius:5px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .15s;flex-shrink:0;}
.cell-task:hover .ct-del{opacity:1;} .ct-del:hover{background:rgba(255,107,107,.12);color:#FF6B6B;}
.add-task-btn{width:100%;border:1.5px dashed var(--border);border-radius:9px;background:transparent;padding:7px;color:var(--muted);font-size:11px;cursor:pointer;transition:all .2s;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:4px;margin-top:4px;}
.add-task-btn:hover{border-color:var(--ink);background:var(--bg);color:var(--ink);}

/* ‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê */
.dash-header{margin-bottom:28px;animation:fadeUp .4s ease both;}
.dash-title{font-family:'Fraunces',serif;font-size:32px;font-weight:900;}
.dash-sub{font-size:13px;color:var(--muted);margin-top:4px;}
.dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.dash-card{background:var(--white);border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);padding:22px 24px;}
.dash-card-label{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-weight:600;margin-bottom:8px;}
.dash-card-value{font-family:'Fraunces',serif;font-size:38px;font-weight:900;color:var(--ink);line-height:1;}
.dash-card-sub{font-size:11px;color:var(--muted);margin-top:4px;}
.dash-card-icon{font-size:28px;margin-bottom:8px;}
.streak-flame{font-size:42px;margin-bottom:4px;}

.dash-row{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:24px;}
.dash-wide{background:var(--white);border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);padding:24px;}
.dash-section-title{font-family:'Fraunces',serif;font-size:16px;font-weight:700;margin-bottom:18px;}

/* Bar chart */
/* ‚îÄ‚îÄ BAR CHART (staircase style) ‚îÄ‚îÄ */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:200px;padding:0 36px 0 8px;position:relative;overflow:visible;}
.bar-chart::before{content:'';position:absolute;left:0;right:0;bottom:28px;border-bottom:1.5px dashed var(--border);}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:0;cursor:pointer;}
.bar-col:hover .bar-inner{filter:brightness(1.1);transform:scaleY(1.03);transform-origin:bottom;}
.bar-outer{flex:1;width:100%;display:flex;align-items:flex-end;}
.bar-inner{width:100%;border-radius:8px 8px 0 0;min-height:4px;transition:height .7s cubic-bezier(.34,1.2,.64,1);position:relative;overflow:hidden;}
.bar-done-fill{position:absolute;bottom:0;left:0;right:0;border-radius:0;transition:height .7s cubic-bezier(.34,1.2,.64,1);}
.bar-label{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;padding:6px 0 0;height:28px;display:flex;align-items:flex-start;justify-content:center;}
.bar-val{font-size:10px;font-weight:800;color:var(--ink);font-family:'Fraunces',serif;margin-bottom:4px;opacity:1;transition:opacity .3s;}
.bar-col:hover .bar-val{opacity:1;}
/* grid lines */
.chart-grid{position:absolute;left:0;right:0;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none;top:0;bottom:28px;}
.chart-grid-line{border-top:1px dashed var(--border);position:relative;}
.chart-grid-line span{position:absolute;left:-4px;top:-7px;font-size:9px;color:var(--muted);font-weight:600;transform:translateX(-100%);white-space:nowrap;}

/* ‚îÄ‚îÄ DONUT (bigger, cleaner) ‚îÄ‚îÄ */
.donut-wrap{display:flex;align-items:center;gap:24px;flex-wrap:wrap;}
.donut-svg{transform:rotate(-90deg);flex-shrink:0;}
.donut-center{font-family:'Fraunces',serif;font-size:22px;font-weight:900;text-anchor:middle;dominant-baseline:middle;fill:var(--ink);}
.donut-legend{display:flex;flex-direction:column;gap:10px;flex:1;min-width:120px;}
.legend-item{display:flex;align-items:center;gap:8px;}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.legend-label{font-size:12px;color:var(--ink);font-weight:600;flex:1;text-transform:capitalize;}
.legend-val{font-size:11px;color:var(--muted);font-weight:700;}
/* category bar in legend */
.legend-bar-wrap{flex:1;height:4px;background:var(--border);border-radius:99px;overflow:hidden;margin-left:4px;}
.legend-bar-fill{height:100%;border-radius:99px;transition:width .8s ease;}

/* Donut chart */
.donut-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;}
.donut-svg{transform:rotate(-90deg);}
.donut-center{font-family:'Fraunces',serif;font-size:22px;font-weight:900;text-anchor:middle;dominant-baseline:middle;fill:var(--ink);}
.donut-legend{display:flex;flex-direction:column;gap:8px;width:100%;}
.legend-item{display:flex;align-items:center;gap:8px;font-size:12px;}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.legend-label{color:var(--muted);flex:1;}
.legend-val{font-weight:700;color:var(--ink);}

/* Best day highlight */
.best-day-card{background:linear-gradient(135deg,var(--ink),#2d2015);border-radius:18px;padding:24px;color:#fff;}
.best-day-card .dash-card-label{color:rgba(255,255,255,.5);}
.best-day-name{font-family:'Fraunces',serif;font-size:42px;font-weight:900;color:#fff;line-height:1;}
.best-day-stat{font-size:12px;color:rgba(255,255,255,.6);margin-top:6px;}

/* Recent weeks */
.week-history{display:flex;flex-direction:column;gap:10px;}
.week-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg);border-radius:10px;border:1px solid var(--border);}
.week-row-label{font-size:12px;font-weight:600;color:var(--ink);min-width:90px;}
.week-row-bar-wrap{flex:1;height:10px;background:var(--border);border-radius:99px;overflow:hidden;}
.week-row-bar{height:100%;border-radius:99px;background:linear-gradient(90deg,#FF6B6B,#FF9F43);transition:width 1s ease;}
.week-row-pct{font-size:11px;font-weight:700;color:var(--ink);min-width:35px;text-align:right;font-family:'Fraunces',serif;}

/* Motivational quote */
.quote-card{background:linear-gradient(135deg,rgba(255,107,107,.08),rgba(255,159,67,.06));border:1px solid rgba(255,107,107,.15);border-radius:18px;padding:24px;text-align:center;}
.quote-text{font-family:'Fraunces',serif;font-size:18px;font-style:italic;color:var(--ink);line-height:1.5;margin-bottom:8px;}
.quote-author{font-size:11px;color:var(--muted);letter-spacing:.5px;}

/* ‚ïê‚ïê NOTIFICATIONS PAGE ‚ïê‚ïê */
.notif-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.notif-card{background:var(--white);border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);padding:28px;}
.notif-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;margin-bottom:6px;}
.notif-sub{font-size:12px;color:var(--muted);margin-bottom:22px;line-height:1.6;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border);}
.toggle-row:last-of-type{border-bottom:none;}
.toggle-info .tl{font-size:13px;font-weight:600;color:var(--ink);}
.toggle-info .ts{font-size:11px;color:var(--muted);margin-top:2px;}
.toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:99px;cursor:pointer;transition:.3s;}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.2);}
.toggle input:checked+.toggle-slider{background:#26de81;}
.toggle input:checked+.toggle-slider::before{transform:translateX(20px);}
.time-picker-row{display:flex;align-items:center;gap:12px;margin-top:16px;}
.time-picker-row label{font-size:12px;font-weight:600;color:var(--ink);}
.time-input{background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:9px 13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;cursor:pointer;}
.time-input:focus{border-color:var(--ink);}
.notif-btn{background:var(--ink);color:#fff;border:none;border-radius:10px;padding:12px 22px;font-family:'Fraunces',serif;font-weight:700;font-size:14px;cursor:pointer;transition:opacity .2s;margin-top:20px;display:block;width:100%;}
.notif-btn:hover{opacity:.85;}
.notif-log{display:flex;flex-direction:column;gap:8px;margin-top:16px;max-height:240px;overflow-y:auto;}
.notif-log-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);font-size:12px;}
.notif-log-icon{font-size:16px;flex-shrink:0;}
.notif-log-text{color:var(--ink);font-weight:500;line-height:1.4;}
.notif-log-time{font-size:10px;color:var(--muted);margin-top:2px;}
.perm-warning{background:#fff8e6;border:1px solid #ffe08a;border-radius:10px;padding:12px 16px;font-size:12px;color:#856404;display:none;margin-top:12px;line-height:1.5;}
.perm-warning.show{display:block;}

/* ‚ïê‚ïê TEMPLATES PAGE ‚ïê‚ïê */
.templates-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.tmpl-card{background:var(--white);border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);padding:28px;}
.tmpl-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;margin-bottom:6px;}
.tmpl-sub{font-size:12px;color:var(--muted);margin-bottom:22px;line-height:1.6;}
.tmpl-list{display:flex;flex-direction:column;gap:10px;}
.tmpl-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;transition:all .2s;}
.tmpl-item:hover{border-color:var(--ink);background:var(--white);}
.tmpl-item-icon{font-size:22px;}
.tmpl-item-info{flex:1;}
.tmpl-item-name{font-size:13px;font-weight:700;color:var(--ink);}
.tmpl-item-count{font-size:11px;color:var(--muted);margin-top:2px;}
.tmpl-item-actions{display:flex;gap:6px;}
.tmpl-load-btn{padding:6px 14px;border-radius:8px;border:none;background:var(--ink);color:#fff;font-size:11px;font-weight:700;cursor:pointer;transition:opacity .2s;font-family:'Plus Jakarta Sans',sans-serif;}
.tmpl-load-btn:hover{opacity:.8;}
.tmpl-del-btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:11px;cursor:pointer;transition:all .2s;}
.tmpl-del-btn:hover{border-color:#FF6B6B;color:#FF6B6B;}
.tmpl-empty{text-align:center;padding:40px 20px;color:var(--muted);}
.tmpl-empty-icon{font-size:40px;margin-bottom:12px;}
.tmpl-empty p{font-size:13px;}
.tmpl-save-form{display:flex;flex-direction:column;gap:12px;}
.tmpl-input{background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:11px 14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;width:100%;}
.tmpl-input:focus{border-color:var(--ink);}
.tmpl-preview{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;max-height:200px;overflow-y:auto;}
.tmpl-preview-day{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;margin-top:10px;}
.tmpl-preview-day:first-child{margin-top:0;}
.tmpl-preview-task{font-size:12px;color:var(--ink);padding:3px 0;display:flex;align-items:center;gap:6px;}
.tmpl-preview-task::before{content:'¬∑';color:var(--muted);}
.tmpl-save-btn{background:var(--ink);color:#fff;border:none;border-radius:10px;padding:13px;font-family:'Fraunces',serif;font-weight:700;font-size:15px;cursor:pointer;transition:opacity .2s;}
.tmpl-save-btn:hover{opacity:.85;}

/* ‚ïê‚ïê MODALS ‚ïê‚ïê */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,18,8,.5);backdrop-filter:blur(6px);z-index:100;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{background:var(--white);border-radius:22px;padding:30px;width:100%;max-width:410px;margin:20px;box-shadow:var(--shadow-lg);animation:modalIn .3s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes modalIn{from{opacity:0;transform:scale(.9) translateY(20px);}to{opacity:1;transform:scale(1) translateY(0);}}
.modal-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 11px;border-radius:99px;font-size:11px;font-weight:700;letter-spacing:.3px;margin-bottom:12px;}
.modal h3{font-family:'Fraunces',serif;font-size:20px;font-weight:900;margin-bottom:16px;color:var(--ink);}
.field{margin-bottom:12px;}
.field label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:5px;font-weight:600;}
.field input,.field select{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:11px 13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:var(--ink);}
.modal-btns{display:flex;gap:8px;margin-top:16px;}
.m-cancel{flex:1;padding:11px;border-radius:9px;background:var(--bg);border:1px solid var(--border);color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;font-size:13px;}
.m-save{flex:2;padding:11px;border-radius:9px;background:var(--ink);border:none;color:#fff;font-family:'Fraunces',serif;font-weight:700;font-size:14px;cursor:pointer;transition:opacity .2s;}
.m-save:hover{opacity:.85;}

/* Confetti */
.confetti-piece{position:fixed;width:8px;height:8px;border-radius:2px;pointer-events:none;z-index:9999;animation:confettiFall 1.8s ease-in both;}
@keyframes confettiFall{
  0%{transform:translateY(-20px) rotate(0deg);opacity:1;}
  100%{transform:translateY(100vh) rotate(720deg);opacity:0;}
}

/* Toast */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--ink);color:#fff;border-radius:11px;padding:11px 22px;font-size:13px;font-weight:500;z-index:999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Responsive */
@media(max-width:1024px){.dash-grid{grid-template-columns:repeat(2,1fr);}.dash-row{grid-template-columns:1fr;}.notif-layout,.templates-layout{grid-template-columns:1fr;}}
@media(max-width:900px){.week-table,thead,tbody,th,td,tr{display:block;}.week-table thead{display:none;}.table-wrap{overflow:visible;}.week-table tbody tr{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}.week-table tbody tr td{border-radius:12px;border:1px solid var(--border);}.tb-week-nav{display:none;}}
@media(max-width:600px){.week-table tbody tr{grid-template-columns:1fr;}.tb-tabs{display:none !important;}.dash-grid{grid-template-columns:1fr;}}

/* MOBILE BOTTOM NAV */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;background:rgba(247,243,238,0.97);backdrop-filter:blur(16px);border-top:1px solid var(--border);padding:8px 0 max(12px,env(safe-area-inset-bottom));box-shadow:0 -4px 20px rgba(26,18,8,0.08);}
.mobile-nav-inner{display:flex;align-items:center;justify-content:space-around;}
.mobile-nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 10px;border:none;background:transparent;cursor:pointer;border-radius:14px;transition:all .2s;-webkit-tap-highlight-color:transparent;min-width:0;flex:1;}
.mobile-nav-btn .mn-icon{font-size:22px;line-height:1;}
.mobile-nav-btn .mn-label{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:.2px;font-family:'Plus Jakarta Sans',sans-serif;transition:color .2s;}
.mobile-nav-btn.active .mn-label{color:var(--ink);}
.mobile-nav-btn.active{background:rgba(26,18,8,0.07);}
.mobile-nav-btn:active{transform:scale(.90);}
#mob-install-btn .mn-icon{
  background:linear-gradient(135deg,#FF6B6B,#FF9F43) !important;
  border-radius:50%;
  width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
  box-shadow:0 2px 10px rgba(255,107,107,.5);
  animation:installPulse 2s ease infinite;
}
#mob-install-btn .mn-label{color:#FF6B6B !important;font-weight:700 !important;}
@keyframes installPulse{
  0%,100%{box-shadow:0 2px 8px rgba(255,107,107,.4);}
  50%{box-shadow:0 2px 16px rgba(255,107,107,.8);}
}

/* Mobile week nav bar */
.mobile-week-bar{display:none;align-items:center;justify-content:center;gap:10px;padding:10px 16px;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:56px;z-index:40;}
.mobile-week-bar .tb-nav-btn{width:32px;height:32px;}
.mobile-week-bar .tb-week-label{font-size:12px;min-width:150px;}
.mobile-week-bar .tb-today-btn{padding:5px 12px;font-size:11px;}

@media(max-width:768px){
  #search-wrap{display:none!important;}
  .mobile-nav{display:block;}
  .mobile-week-bar{display:flex;}
  .tb-tabs{display:none !important;}
  .tb-week-nav{display:none !important;}
  .tb-name{display:none;}
  .topbar{padding:0 16px;height:56px;}
  .tb-logo{font-size:18px;}
  .page{padding:16px 12px 100px;}
  .summary{gap:8px;}
  .sum-card{min-width:80px;padding:12px 14px;}
  .sum-value{font-size:22px;}
  .dash-grid{grid-template-columns:1fr 1fr;gap:10px;}
  .dash-card{padding:16px 14px;}
  .dash-card-value{font-size:28px;}
  .dash-row{grid-template-columns:1fr;gap:12px;}
  .notif-layout,.templates-layout{grid-template-columns:1fr;gap:14px;}
  .bar-chart{height:160px !important;}
  .auth-box{padding:32px 24px;}
  .motiv-banner{flex-wrap:wrap;}
  .template-bar{display:none;}
  .week-table tbody tr{grid-template-columns:1fr !important;}
  .week-table tbody tr td{border-radius:14px;border:1px solid var(--border);background:var(--white);}
  .day-cell{min-height:auto;padding-bottom:4px;}
  .table-wrap{background:transparent;border:none;box-shadow:none;}
  .week-table{background:transparent;}
}
@media(max-width:420px){
  .week-table tbody tr{grid-template-columns:1fr;}
  .dash-grid{grid-template-columns:1fr;}
  .mobile-nav-btn{padding:6px 10px;}
  .mobile-nav-btn .mn-label{font-size:9px;}
}


/* ‚ïê‚ïê BOARDS PAGE (Trello-style) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.boards-layout{display:flex;flex-direction:column;height:calc(100vh - 62px);overflow:hidden;}
.boards-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;flex-shrink:0;}
.boards-title-row{display:flex;align-items:center;gap:12px;}
.boards-back{background:transparent;border:1.5px solid var(--border);border-radius:9px;padding:7px 14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;}
.boards-back:hover{border-color:var(--ink);color:var(--ink);}
.boards-page-title{font-family:'Fraunces',serif;font-size:26px;font-weight:900;}
.boards-page-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.new-board-btn{background:var(--ink);color:#fff;border:none;border-radius:10px;padding:10px 18px;font-family:'Fraunces',serif;font-weight:700;font-size:13px;cursor:pointer;transition:opacity .2s;display:flex;align-items:center;gap:6px;}
.new-board-btn:hover{opacity:.85;}

/* Board list grid */
.boards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;padding:0 24px 24px;}
.board-card{border-radius:16px;padding:22px;cursor:pointer;transition:transform .15s,box-shadow .2s;position:relative;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;}
.board-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.board-card-name{font-family:'Fraunces',serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:6px;}
.board-card-meta{font-size:11px;color:rgba(255,255,255,.7);}
.board-card-members{display:flex;gap:-4px;margin-top:10px;}
.board-member-av{width:24px;height:24px;border-radius:50%;border:2px solid rgba(255,255,255,.4);background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;margin-left:-6px;}
.board-member-av:first-child{margin-left:0;}
.board-card-more{position:absolute;top:12px;right:12px;background:rgba(255,255,255,.2);border:none;border-radius:6px;width:28px;height:28px;color:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;}
.board-card:hover .board-card-more{opacity:1;}
.board-card-del{background:rgba(255,255,255,.15);border:none;border-radius:7px;padding:4px 9px;color:#fff;cursor:pointer;font-size:14px;transition:background .15s;}
.board-card-del:hover{background:rgba(255,80,80,.5);}
.board-add-card{border:2px dashed var(--border);border-radius:16px;padding:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:13px;font-weight:600;transition:all .2s;min-height:120px;}
.board-add-card:hover{border-color:var(--ink);color:var(--ink);background:var(--bg);}

/* Board view (kanban) */
.board-view{display:none;flex-direction:column;height:100%;}
.board-view.active{display:flex;}
.board-topbar{display:flex;align-items:center;gap:14px;padding:14px 24px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.board-view-title{font-family:'Fraunces',serif;font-size:20px;font-weight:900;flex:1;}
.board-invite-btn{background:transparent;border:1.5px solid var(--border);border-radius:9px;padding:7px 14px;font-size:12px;font-weight:600;color:var(--ink);cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;}
.board-invite-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink);}
.board-members-row{display:flex;align-items:center;gap:4px;}
.bm-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#FF6B6B,#FF9F43);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;border:2px solid var(--white);margin-left:-6px;cursor:pointer;transition:transform .15s;}
.bm-av:first-child{margin-left:0;}
.bm-av:hover{transform:scale(1.1);}

/* Columns */
.board-columns-wrap{display:flex;gap:14px;padding:16px 24px 24px;overflow-x:auto;flex:1;align-items:flex-start;}
.board-column{background:var(--bg);border-radius:14px;width:280px;flex-shrink:0;display:flex;flex-direction:column;max-height:calc(100vh - 180px);}
.col-header{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px;gap:8px;}
.col-title-input{font-family:'Fraunces',serif;font-size:14px;font-weight:700;color:var(--ink);background:transparent;border:none;outline:none;flex:1;cursor:text;}
.col-title-input:focus{background:var(--white);border-radius:6px;padding:2px 6px;}
.col-count{font-size:10px;font-weight:700;padding:2px 7px;border-radius:99px;background:var(--border);color:var(--muted);}
.col-menu-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px 4px;border-radius:5px;transition:background .15s;}
.col-menu-btn:hover{background:var(--border);}
.col-cards{display:flex;flex-direction:column;gap:8px;padding:0 10px 10px;overflow-y:auto;flex:1;}
.col-cards.drag-over{background:rgba(69,170,242,.06);border-radius:10px;outline:2px dashed rgba(69,170,242,.3);}

/* Kanban card */
.k-card{background:var(--white);border-radius:10px;padding:12px 13px;border:1px solid var(--border);cursor:pointer;transition:transform .15s,box-shadow .15s;animation:taskPop .2s ease both;position:relative;}
.k-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.1);}
.k-card.dragging{opacity:.4;transform:scale(.97);}
.k-card-title{font-size:13px;font-weight:600;color:var(--ink);line-height:1.4;margin-bottom:6px;}
.k-card-notes{font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.4;}
.k-card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.k-card-pri{font-size:9px;padding:2px 7px;border-radius:99px;font-weight:700;}
.k-card-pri.high{background:rgba(255,107,107,.15);color:#FF6B6B;}
.k-card-pri.medium{background:rgba(255,159,67,.15);color:#FF9F43;}
.k-card-pri.low{background:rgba(38,222,129,.15);color:#26de81;}
.k-card-assignee{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#45aaf2,#a29bfe);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;margin-left:auto;}
.k-card-del{position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:11px;opacity:0;transition:opacity .15s;}
.k-card:hover .k-card-del{opacity:1;}

/* Add card btn */
.add-card-btn{width:100%;padding:9px 14px;border:1.5px dashed var(--border);border-radius:9px;background:transparent;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;text-align:left;transition:all .2s;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;gap:6px;margin:0 10px 10px;width:calc(100% - 20px);}
.add-card-btn:hover{border-color:var(--ink);color:var(--ink);background:var(--white);}

/* Add column */
.add-col-btn{background:rgba(255,255,255,.6);border:2px dashed var(--border);border-radius:14px;width:240px;flex-shrink:0;padding:20px;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;align-self:flex-start;}
.add-col-btn:hover{border-color:var(--ink);color:var(--ink);background:var(--white);}

/* Invite modal */
.invite-input{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:11px 14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;margin-bottom:10px;}
.invite-input:focus{border-color:var(--ink);}
.members-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.member-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border-radius:10px;}
.member-av-lg{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#FF6B6B,#FF9F43);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.member-info{flex:1;}
.member-name{font-size:13px;font-weight:600;color:var(--ink);}
.member-email{font-size:11px;color:var(--muted);}
.member-role{font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;background:rgba(69,170,242,.15);color:#45aaf2;}
.member-del{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px;transition:color .15s;}
.member-del:hover{color:#FF6B6B;}

/* Card detail modal */
.card-modal-title-input{width:100%;font-family:'Fraunces',serif;font-size:20px;font-weight:900;color:var(--ink);background:transparent;border:none;outline:none;border-bottom:2px solid var(--border);padding-bottom:8px;margin-bottom:16px;transition:border-color .2s;}
.card-modal-title-input:focus{border-color:var(--ink);}

@media(max-width:768px){
  .board-columns-wrap{padding:12px 12px 80px;}
  .board-column{width:260px;}
  .boards-grid{grid-template-columns:1fr;padding:0 12px 24px;}
}


/* ‚ïê‚ïê HABITS PAGE ‚Äî PRO DESIGN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.habits-layout{padding:28px 32px;max-width:1200px;margin:0 auto;}
.habits-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
.habits-title-wrap{}
.habits-title{font-family:'Fraunces',serif;font-size:32px;font-weight:900;line-height:1.1;}
.habits-subtitle{font-size:13px;color:var(--muted);margin-top:4px;}
.add-habit-btn{background:var(--ink);color:#fff;border:none;border-radius:12px;padding:11px 22px;font-family:'Fraunces',serif;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;box-shadow:0 4px 14px rgba(26,18,8,.18);}
.add-habit-btn:hover{opacity:.88;transform:translateY(-1px);}

/* Week label bar */
.habits-week-bar{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.habits-week-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
.habits-week-range{font-family:'Fraunces',serif;font-size:15px;font-weight:700;color:var(--ink);}

/* Grid wrapper */
.habits-grid-wrap{background:var(--white);border-radius:20px;border:1px solid var(--border);overflow:hidden;box-shadow:0 4px 32px rgba(26,18,8,.07);width:100%;}
.habits-grid{display:grid;min-width:max-content;}

/* Corner header */
.hg-corner{background:var(--white);position:sticky;left:0;z-index:3;border-bottom:2px solid var(--border);padding:18px 24px;display:flex;align-items:center;gap:8px;min-width:220px;}
.hg-corner-label{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;}

/* Day headers */
.hg-day-header{padding:14px 8px 12px;text-align:center;border-bottom:2px solid var(--border);border-left:1px solid var(--border);min-width:72px;transition:background .15s;}
.hg-day-num{font-size:18px;font-weight:900;color:var(--ink);font-family:'Fraunces',serif;line-height:1;}
.hg-day-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:3px;}
.hg-day-header.today-col-h{background:var(--ink);}
.hg-day-header.today-col-h .hg-day-num{color:#fff;}
.hg-day-header.today-col-h .hg-day-label{color:rgba(255,255,255,.6);}

/* Habit row label */
.habit-row-label{background:var(--white);position:sticky;left:0;z-index:2;display:flex;align-items:center;gap:12px;padding:14px 24px;border-bottom:1px solid var(--border);border-right:2px solid var(--border);min-width:220px;transition:background .15s;}
.habit-row-label:hover{background:var(--bg);}
.habit-row-label:hover .habit-del-btn{opacity:1;}
.habit-emoji{font-size:22px;flex-shrink:0;}
.habit-name-wrap{flex:1;min-width:0;}
.habit-name{font-size:13px;font-weight:700;color:var(--ink);display:block;}
.habit-streak{font-size:11px;font-weight:600;color:var(--muted);display:flex;align-items:center;gap:3px;margin-top:2px;}
.habit-streak.on-fire{color:#FF9F43;}
.habit-del-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px;opacity:0;transition:opacity .15s;padding:4px 6px;border-radius:6px;flex-shrink:0;}
.habit-del-btn:hover{color:#FF6B6B;background:rgba(255,107,107,.1);}

/* Habit cells */
.habit-cell{display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--border);border-left:1px solid var(--border);min-width:72px;min-height:58px;cursor:pointer;transition:background .15s;position:relative;}
.habit-cell:hover{background:rgba(69,170,242,.05);}
.habit-check{width:32px;height:32px;border-radius:9px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;transition:all .25s cubic-bezier(.34,1.4,.64,1);font-size:16px;background:var(--white);}
.habit-cell:hover .habit-check{border-color:#45aaf2;transform:scale(1.08);}
.habit-cell.done .habit-check{background:var(--ink);border-color:var(--ink);color:#fff;transform:scale(1.05);}
.habit-cell.done .habit-check::after{content:'‚úì';font-weight:900;}
.habit-cell.today-col-c{background:rgba(26,18,8,.02);}
.habit-cell.today-col-c .habit-check{border-color:#45aaf2;}

/* Summary row */
.hg-summary-label{background:var(--bg);position:sticky;left:0;z-index:2;padding:14px 24px;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;border-top:2px solid var(--border);min-width:220px;display:flex;align-items:center;}
.hg-summary-cell{background:var(--bg);display:flex;align-items:center;justify-content:center;border-top:2px solid var(--border);border-left:1px solid var(--border);min-width:72px;min-height:48px;}
.hg-summary-pill{height:10px;width:38px;border-radius:99px;background:var(--border);transition:background .3s;}
.hg-summary-pill.full{background:linear-gradient(90deg,#26de81,#45aaf2);}
.hg-summary-pill.partial{background:#f0c040;}

/* Empty state */
.habits-empty{text-align:center;padding:80px 20px;color:var(--muted);}
.habits-empty-icon{font-size:64px;margin-bottom:16px;}
.habits-empty-title{font-family:'Fraunces',serif;font-size:24px;font-weight:900;color:var(--ink);margin-bottom:8px;}

/* Emoji picker */
.habit-emoji-picker{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.hep-btn{width:38px;height:38px;border-radius:9px;border:2px solid transparent;background:var(--bg);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.hep-btn.active,.hep-btn:hover{border-color:var(--ink);background:var(--white);transform:scale(1.1);}

[data-theme="dark"] .hg-day-header.today-col-h{background:#fff;}
[data-theme="dark"] .hg-day-header.today-col-h .hg-day-num{color:#1A1208;}
[data-theme="dark"] .hg-day-header.today-col-h .hg-day-label{color:rgba(26,18,8,.5);}
[data-theme="dark"] .habit-cell.done .habit-check{background:#fff;border-color:#fff;color:#1A1208;}

@media(max-width:768px){
  .habits-layout{padding:16px 12px;}
  .habits-title{font-size:24px;}
  .hg-corner,.habit-row-label{min-width:140px;padding:12px 14px;}
  .hg-day-header,.habit-cell{min-width:52px;}
  .habit-check{width:26px;height:26px;}
}

::-webkit-scrollbar{width:5px;height:5px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

/* ‚ïê‚ïê POMODORO PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.pomo-page{display:flex;flex-direction:column;align-items:center;padding:40px 20px;gap:32px;min-height:100%;}
.pomo-modes{display:flex;gap:8px;background:var(--bg);border-radius:14px;padding:5px;}
.pomo-mode-btn{padding:8px 20px;border-radius:10px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;}
.pomo-mode-btn.active{background:var(--white);color:var(--ink);box-shadow:0 2px 8px rgba(0,0,0,.08);}

/* Ring timer */
.pomo-ring-wrap{position:relative;width:260px;height:260px;display:flex;align-items:center;justify-content:center;}
.pomo-ring-svg{position:absolute;top:0;left:0;transform:rotate(-90deg);}
.pomo-ring-bg{fill:none;stroke:var(--bg);stroke-width:10;}
.pomo-ring-progress{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset .9s ease, stroke .4s ease;}
.pomo-ring-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;z-index:1;}
.pomo-time{font-family:'Fraunces',serif;font-size:58px;font-weight:900;color:var(--ink);line-height:1;letter-spacing:-2px;}
.pomo-session-label{font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);}

/* Controls */
.pomo-controls{display:flex;align-items:center;gap:16px;}
.pomo-btn-main{width:64px;height:64px;border-radius:50%;border:none;font-size:24px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,.12);}
.pomo-btn-main:hover{transform:scale(1.08);}
.pomo-btn-main:active{transform:scale(.95);}
.pomo-btn-side{width:44px;height:44px;border-radius:50%;border:2px solid var(--border);background:transparent;font-size:16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;color:var(--muted);}
.pomo-btn-side:hover{background:var(--bg);color:var(--ink);}

/* Stats row */
.pomo-stats{display:flex;gap:20px;}
.pomo-stat{display:flex;flex-direction:column;align-items:center;gap:3px;padding:14px 22px;background:var(--white);border-radius:14px;border:1px solid var(--border);}
.pomo-stat-val{font-family:'Fraunces',serif;font-size:26px;font-weight:900;color:var(--ink);}
.pomo-stat-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);}

/* Task picker */
.pomo-task-section{width:100%;max-width:420px;}
.pomo-task-label{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;display:block;}
.pomo-task-pick{width:100%;background:var(--white);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;cursor:pointer;transition:border-color .2s;}
.pomo-task-pick:focus{border-color:var(--ink);}
.pomo-active-task{display:none;align-items:center;gap:10px;padding:12px 14px;background:var(--white);border:1.5px solid var(--border);border-radius:12px;margin-top:10px;}
.pomo-active-task.show{display:flex;}
.pomo-active-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;animation:pomoPulse 1.5s infinite;}
@keyframes pomoPulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(1.3);}}
.pomo-active-text{font-size:13px;font-weight:600;color:var(--ink);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* Session history */
.pomo-history{width:100%;max-width:420px;}
.pomo-hist-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.pomo-hist-row:last-child{border-bottom:none;}
.pomo-hist-emoji{font-size:16px;}
.pomo-hist-info{flex:1;}
.pomo-hist-task{font-size:12px;font-weight:600;color:var(--ink);}
.pomo-hist-time{font-size:10px;color:var(--muted);}
.pomo-hist-dur{font-size:12px;font-weight:700;color:var(--muted);}

/* Settings panel */
.pomo-settings{width:100%;max-width:420px;background:var(--white);border:1px solid var(--border);border-radius:16px;padding:20px;}
.pomo-settings-title{font-size:13px;font-weight:700;color:var(--ink);margin-bottom:14px;}
.pomo-setting-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);}
.pomo-setting-row:last-child{border-bottom:none;}
.pomo-setting-lbl{font-size:12px;color:var(--ink);}
.pomo-setting-input{width:60px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:5px 8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--ink);text-align:center;outline:none;}
.pomo-setting-input:focus{border-color:var(--ink);}

/* Notification dot when running */
.pomo-running-dot{display:none;width:8px;height:8px;border-radius:50%;background:#FF6B6B;position:absolute;top:6px;right:6px;animation:pomoPulse 1s infinite;}
.pomo-running-dot.show{display:block;}

/* ‚ïê‚ïê TASK DETAIL MODAL ‚ïê‚ïê */
#task-modal .modal{max-width:460px;}
.task-modal-title{font-family:'Fraunces',serif;font-size:20px;font-weight:900;margin-bottom:4px;color:var(--ink);}
.task-modal-meta{display:flex;gap:8px;align-items:center;margin-bottom:18px;flex-wrap:wrap;}
.task-modal-tag{font-size:10px;padding:3px 9px;border-radius:99px;font-weight:700;}
.notes-label{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:6px;font-weight:600;display:block;}
.notes-textarea{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--ink);outline:none;transition:border-color .2s;resize:vertical;min-height:90px;line-height:1.6;}
.notes-textarea:focus{border-color:var(--ink);}
.notes-preview{font-size:11px;color:var(--muted);margin-top:4px;font-style:italic;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
/* recurring toggle in add modal */
.recur-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0 0;}
.recur-row label{font-size:12px;font-weight:600;color:var(--ink);}
.recur-select{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:6px 10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--ink);outline:none;display:none;}
.recur-select.show{display:block;}
/* recurring badge on task card */
.ct-recur{font-size:9px;padding:1px 6px;border-radius:99px;font-weight:700;background:rgba(162,155,254,.18);color:#6c5ce7;letter-spacing:.2px;}
/* notes icon on task card */
.ct-notes-icon{font-size:11px;color:var(--muted);cursor:pointer;flex-shrink:0;opacity:.7;}
.ct-notes-icon:hover{opacity:1;}
/* Task detail modal save btn */
.task-modal-save{width:100%;padding:12px;border-radius:10px;border:none;background:var(--ink);color:#fff;font-family:'Fraunces',serif;font-weight:700;font-size:14px;cursor:pointer;transition:opacity .2s;margin-top:14px;}
.task-modal-save:hover{opacity:.85;}
.task-modal-close{position:absolute;top:16px;right:16px;background:transparent;border:none;font-size:20px;color:var(--muted);cursor:pointer;line-height:1;}


/* ‚ïê‚ïê MOBILE DAY LABEL (shown inside each cell on mobile) ‚ïê‚ïê */
.mobile-day-label {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px 8px;
  margin: -10px -8px 8px -8px;
  border-bottom: 1px solid var(--border);
}
.mobile-day-label .mdl-left { display:flex; align-items:center; gap:10px; }
.mobile-day-label .mdl-day {
  font-family: 'Fraunces', serif;
  font-weight: 900;
  font-size: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.mobile-day-label .mdl-date {
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
}
.mobile-day-label .mdl-num {
  font-family: 'Fraunces', serif;
  font-weight: 900;
  font-size: 32px;
  line-height: 1;
}
.mobile-day-label .mdl-badge {
  font-size: 10px;
  padding: 3px 9px;
  border-radius: 99px;
  font-weight: 700;
}
.mobile-day-label .mdl-add {
  width: 30px; height: 30px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  background: transparent;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
  color: var(--ink);
  flex-shrink: 0;
}
.mobile-day-label .mdl-add:hover { background: var(--ink); color: #fff; border-color: var(--ink); }

/* Today highlight for mobile label */
.mobile-day-label.today-label { background: var(--ink); margin-bottom: 8px; border-radius: 8px; border-bottom: none; }
.mobile-day-label.today-label .mdl-day,
.mobile-day-label.today-label .mdl-date,
.mobile-day-label.today-label .mdl-num { color: #fff !important; }
.mobile-day-label.today-label .mdl-badge { background: rgba(255,255,255,.2); color: #fff; }
.mobile-day-label.today-label .mdl-add { border-color: rgba(255,255,255,.3); color: #fff; }
.mobile-day-label.today-label .mdl-add:hover { background: rgba(255,255,255,.2); }

@media(max-width:768px) {
  .mobile-day-label { display: flex; }
  /* Hide the add button inside cell on mobile since it's in the label now */
  .day-cell .add-task-btn { display: flex; }
}

/* ‚ïê‚ïê INSTALL BUTTON ‚Äî ALWAYS VISIBLE, CANNOT BE DISMISSED ‚ïê‚ïê */
.install-fab {
  position: fixed;
  bottom: 88px;
  right: 16px;
  z-index: 250;
  background: linear-gradient(135deg, #FF6B6B, #FF9F43);
  color: #fff;
  border: none;
  border-radius: 99px;
  padding: 11px 18px;
  font-family: 'Fraunces', serif;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(255,107,107,.45);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: transform .2s, box-shadow .2s;
  animation: fabPulse 2.5s ease infinite;
  -webkit-tap-highlight-color: transparent;
}
.install-fab:hover { transform: translateY(-2px) scale(1.04); box-shadow: 0 8px 28px rgba(255,107,107,.5); }
.install-fab:active { transform: scale(.95); }
.install-fab.hidden { display: none !important; }
.install-fab .fab-icon { font-size: 18px; }
@keyframes fabPulse {
  0%,100% { box-shadow: 0 4px 20px rgba(255,107,107,.45); }
  50%      { box-shadow: 0 4px 30px rgba(255,107,107,.75); }
}

/* iOS instruction modal */
.ios-modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 400;
  align-items: flex-end;
  justify-content: center;
  background: rgba(26,18,8,.5);
  backdrop-filter: blur(6px);
}
.ios-modal.show { display: flex; }
.ios-modal-box {
  background: var(--white);
  border-radius: 24px 24px 0 0;
  padding: 32px 28px 48px;
  width: 100%;
  max-width: 480px;
  animation: slideUp .35s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes slideUp { from{transform:translateY(100%);opacity:0;} to{transform:translateY(0);opacity:1;} }
.ios-modal-title {
  font-family: 'Fraunces', serif;
  font-weight: 900;
  font-size: 22px;
  margin-bottom: 6px;
  text-align: center;
}
.ios-modal-sub { font-size:13px; color:var(--muted); text-align:center; margin-bottom:28px; line-height:1.6; }
.ios-steps { display:flex; flex-direction:column; gap:16px; margin-bottom:28px; }
.ios-step {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: var(--bg);
  border-radius: 12px;
  border: 1px solid var(--border);
}
.ios-step-num {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: var(--ink);
  color: #fff;
  font-family: 'Fraunces', serif;
  font-weight: 900;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.ios-step-icon { font-size: 22px; flex-shrink: 0; }
.ios-step-text { font-size: 13px; font-weight: 600; color: var(--ink); line-height: 1.4; }
.ios-step-text span { color: var(--muted); font-weight: 400; display: block; font-size: 11px; margin-top: 2px; }
.ios-close-btn {
  width: 100%; padding: 14px; border-radius: 12px;
  background: var(--ink); border: none; color: #fff;
  font-family: 'Fraunces', serif; font-weight: 700; font-size: 15px;
  cursor: pointer; transition: opacity .2s;
}
.ios-close-btn:hover { opacity: .85; }

/* On desktop ‚Äî show install button in topbar instead */
@media(min-width:769px) {
  .install-fab { display: none; }
  .tb-install-btn {
    display: flex !important;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg,#FF6B6B,#FF9F43);
    color: #fff;
    border: none;
    border-radius: 99px;
    padding: 7px 16px;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: opacity .2s;
  }
  .tb-install-btn:hover { opacity: .85; }
  .tb-install-btn.hidden { display: none !important; }
}
@media(max-width:768px) {
  .tb-install-btn { display: none !important; }
}

/* ‚ïê‚ïê PWA INSTALL BANNER ‚ïê‚ïê */
.pwa-banner{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  z-index:300;background:var(--ink);color:#fff;
  border-radius:16px;padding:14px 20px;
  display:flex;align-items:center;gap:14px;
  box-shadow:0 8px 32px rgba(0,0,0,.3);
  opacity:0;pointer-events:none;
  transition:all .4s cubic-bezier(0.34,1.56,0.64,1);
  max-width:340px;width:calc(100% - 32px);
}
.pwa-banner.show{opacity:1;pointer-events:all;transform:translateX(-50%) translateY(0);}
.pwa-banner-icon{font-size:28px;flex-shrink:0;}
.pwa-banner-text{flex:1;}
.pwa-banner-title{font-family:'Fraunces',serif;font-weight:700;font-size:14px;margin-bottom:2px;}
.pwa-banner-sub{font-size:11px;color:rgba(255,255,255,.6);}
.pwa-banner-btn{background:linear-gradient(135deg,#FF6B6B,#FF9F43);border:none;border-radius:10px;padding:8px 14px;color:#fff;font-family:'Fraunces',serif;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap;flex-shrink:0;}
.pwa-banner-close{background:transparent;border:none;color:rgba(255,255,255,.5);cursor:pointer;font-size:18px;flex-shrink:0;padding:0 0 0 4px;}

/* ‚ïê‚ïê OFFLINE BANNER ‚ïê‚ïê */
.offline-bar{
  position:fixed;top:0;left:0;right:0;z-index:400;
  background:#FF6B6B;color:#fff;
  text-align:center;padding:8px;font-size:12px;font-weight:600;
  transform:translateY(-100%);transition:transform .3s ease;
  letter-spacing:.3px;
}
.offline-bar.show{transform:translateY(0);}

/* ‚ïê‚ïê SWIPE TO DELETE ‚ïê‚ïê */
.swipe-wrap{position:relative;overflow:hidden;border-radius:9px;margin-bottom:0;}
.swipe-delete-bg{
  position:absolute;right:0;top:0;bottom:0;
  background:linear-gradient(135deg,#FF6B6B,#ff4444);
  display:flex;align-items:center;justify-content:flex-end;
  padding-right:16px;border-radius:9px;
  min-width:80px;
}
.swipe-delete-bg span{font-size:18px;}
.cell-task{transition:transform .2s ease,box-shadow .15s,opacity .2s;touch-action:pan-y;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading"><div class="loader"></div><div class="loader-text">LOADING WEEKFLOW PRO...</div></div>

<!-- AUTH -->
<div id="auth-screen" class="hidden">
  <div class="auth-box">
    <div class="auth-logo">Week<span>Flow</span></div>
    <div class="auth-badge">‚ú¶ PRO</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">Sign Up</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
    <div id="form-login">
      <div class="auth-field"><label>Email</label><input type="email" id="login-email" placeholder="you@email.com"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="auth-btn-primary" onclick="emailLogin()">Sign In ‚Üí</button>
    </div>
    <div id="form-signup" style="display:none">
      <div class="auth-field"><label>Your Name</label><input type="text" id="signup-name" placeholder="e.g. Ahmed"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="signup-email" placeholder="you@email.com"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="signup-pass" placeholder="Min 6 characters"></div>
      <button class="auth-btn-primary" onclick="emailSignup()">Create Account ‚Üí</button>
    </div>
    <div class="auth-divider">or</div>
    <button class="auth-google" onclick="googleLogin()">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="tb-logo">Week<span>Flow</span><span class="tb-pro">PRO</span></div>
    <div class="tb-tabs">
      <button class="tb-tab active" onclick="showPage('planner')" id="tab-planner">üìÖ Planner</button>
      <button class="tb-tab" onclick="showPage('dashboard')" id="tab-dashboard">üìä Dashboard</button>
      <button class="tb-tab" onclick="showPage('pomodoro')" id="tab-pomodoro" style="position:relative;">üçÖ Focus<span class="pomo-running-dot" id="pomo-dot"></span></button>
      <button class="tb-tab" onclick="showPage('boards')" id="tab-boards">üóÇÔ∏è Boards</button>
      <button class="tb-tab" onclick="showPage('habits')" id="tab-habits">üéØ Habits</button>
    </div>
    <div class="tb-week-nav">
      <button class="tb-nav-btn" id="prev-week">‚óÄ</button>
      <div class="tb-week-label" id="week-label">‚Äî</div>
      <button class="tb-nav-btn" id="next-week">‚ñ∂</button>
      <button class="tb-today-btn" id="today-btn">Today</button>
    </div>
    <div class="tb-right">
      <!-- Search -->
      <div class="search-wrap" id="search-wrap">
        <input class="search-input" id="search-input" placeholder="Search tasks..." autocomplete="off">
        <span class="search-icon">üîç</span>
        <button class="search-btn" id="search-btn" title="Search">üîç</button>
        <div class="search-results" id="search-results"></div>
      </div>
      <!-- Dark mode toggle -->
      <button class="dark-toggle" id="dark-toggle" title="Toggle dark mode" onclick="toggleDarkMode()">üåô</button>
      <button class="tb-install-btn" id="tb-install-btn" title="Install App">üì≤ Install App</button>
      <div class="tb-avatar" id="tb-avatar">?</div>
      <div class="tb-name" id="tb-name">‚Äî</div>
      <span class="saving-dot" id="saving-dot" style="display:none"></span>
      <button class="tb-logout" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <!-- Mobile week nav bar -->
  <div class="mobile-week-bar" id="mobile-week-bar">
    <button class="tb-nav-btn" id="mob-prev-week">‚óÄ</button>
    <div class="tb-week-label" id="mob-week-label">‚Äî</div>
    <button class="tb-nav-btn" id="mob-next-week">‚ñ∂</button>
    <button class="tb-today-btn" id="mob-today-btn">Today</button>
  </div>

  <!-- ‚ïê‚ïê PLANNER PAGE ‚ïê‚ïê -->
  <div class="page active" id="page-planner">
    <div class="summary">
      <div class="sum-card"><div class="sum-label">Total</div><div class="sum-value" id="s-total">0</div><div class="sum-sub">this week</div></div>
      <div class="sum-card"><div class="sum-label">Done</div><div class="sum-value" id="s-done">0</div><div class="sum-sub">completed</div></div>
      <div class="sum-card"><div class="sum-label">Pending</div><div class="sum-value" id="s-pending">0</div><div class="sum-sub">remaining</div></div>
      <div class="sum-card"><div class="sum-label">Busiest</div><div class="sum-value" id="s-busiest" style="font-size:17px;padding-top:5px;">‚Äî</div><div class="sum-sub" id="s-busiest-sub"></div></div>
      <div class="progress-card"><div class="progress-row"><span>Weekly Progress</span><strong id="s-pct">0%</strong></div><div class="prog-track"><div class="prog-fill" id="s-bar" style="width:0%"></div></div></div>
    </div>

    <!-- Motivational banner -->
    <div class="motiv-banner" id="motiv-banner">
      <div class="motiv-emoji" id="motiv-emoji">üéâ</div>
      <div><div class="motiv-text" id="motiv-text">Amazing work!</div><div class="motiv-sub" id="motiv-sub"></div></div>
      <button class="motiv-close" onclick="document.getElementById('motiv-banner').classList.remove('show')">√ó</button>
    </div>

    <!-- Template bar -->
    <div class="template-bar">
      <div class="template-bar-label">Templates:</div>
      <div id="template-chips"></div>
    </div>

    <div class="table-wrap">
      <table class="week-table"><thead><tr id="header-row"></tr></thead><tbody><tr id="body-row"></tr></tbody></table>
    </div>
  </div>

  <!-- ‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê -->
  <div class="page" id="page-dashboard">
    <div class="dash-header">
      <div class="dash-title">Your Analytics</div>
      <div class="dash-sub">Track your productivity and build better habits.</div>
    </div>
    <div class="dash-grid">
      <div class="dash-card"><div class="streak-flame" id="streak-emoji">üî•</div><div class="dash-card-label">Current Streak</div><div class="dash-card-value" id="dash-streak">0</div><div class="dash-card-sub">weeks in a row</div></div>
      <div class="dash-card"><div class="dash-card-icon">‚úÖ</div><div class="dash-card-label">All-Time Completed</div><div class="dash-card-value" id="dash-total-done">0</div><div class="dash-card-sub">tasks finished</div></div>
      <div class="dash-card"><div class="dash-card-icon">üìà</div><div class="dash-card-label">Best Week Rate</div><div class="dash-card-value" id="dash-best-rate">0%</div><div class="dash-card-sub">completion rate</div></div>
      <div class="dash-card"><div class="dash-card-icon">‚ö°</div><div class="dash-card-label">Avg Tasks/Week</div><div class="dash-card-value" id="dash-avg">0</div><div class="dash-card-sub">per week</div></div>
    </div>
    <div class="dash-row">
      <div class="dash-wide">
        <div class="dash-section-title">Tasks by Day of Week</div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:10px;">Hover a bar to see details ¬∑ white overlay = % completed</div>
        <div class="bar-chart" id="bar-chart"></div>
      </div>
      <div class="dash-wide">
        <div class="dash-section-title">This Week by Category</div>
        <div class="donut-wrap">
          <svg width="160" height="160" class="donut-svg" viewBox="0 0 130 130" id="donut-svg"></svg>
          <div class="donut-legend" id="donut-legend"></div>
        </div>
      </div>
    </div>
    <div class="dash-row">
      <div class="dash-wide">
        <div class="dash-section-title">Recent Weeks</div>
        <div class="week-history" id="week-history"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="best-day-card">
          <div class="dash-card-label">Most Productive Day</div>
          <div class="best-day-name" id="best-day-name">‚Äî</div>
          <div class="best-day-stat" id="best-day-stat"></div>
        </div>
        <div class="quote-card">
          <div class="quote-text" id="quote-text">"The secret of getting ahead is getting started."</div>
          <div class="quote-author" id="quote-author">‚Äî Mark Twain</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TEMPLATES PAGE ‚ïê‚ïê -->

  <!-- ‚ïê‚ïê POMODORO PAGE ‚ïê‚ïê -->
  <div class="page" id="page-pomodoro">
    <div class="pomo-page">

      <!-- Mode selector -->
      <div class="pomo-modes">
        <button class="pomo-mode-btn active" id="pomo-mode-focus" onclick="setPomoMode('focus')">üçÖ Focus</button>
        <button class="pomo-mode-btn" id="pomo-mode-short" onclick="setPomoMode('short')">‚òï Short Break</button>
        <button class="pomo-mode-btn" id="pomo-mode-long" onclick="setPomoMode('long')">üõå Long Break</button>
      </div>

      <!-- Ring timer -->
      <div class="pomo-ring-wrap">
        <svg class="pomo-ring-svg" width="260" height="260" viewBox="0 0 260 260">
          <circle class="pomo-ring-bg" cx="130" cy="130" r="115"/>
          <circle class="pomo-ring-progress" id="pomo-ring" cx="130" cy="130" r="115"
            stroke-dasharray="722.6" stroke-dashoffset="0" stroke="#FF6B6B"/>
        </svg>
        <div class="pomo-ring-inner">
          <div class="pomo-time" id="pomo-time">25:00</div>
          <div class="pomo-session-label" id="pomo-session-label">Focus Session</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="pomo-controls">
        <button class="pomo-btn-side" onclick="resetPomo()" title="Reset">‚Ü∫</button>
        <button class="pomo-btn-main" id="pomo-play-btn" onclick="togglePomo()" style="background:#FF6B6B;color:#fff;">‚ñ∂</button>
        <button class="pomo-btn-side" onclick="skipPomo()" title="Skip">‚è≠</button>
      </div>

      <!-- Stats -->
      <div class="pomo-stats">
        <div class="pomo-stat">
          <div class="pomo-stat-val" id="pomo-count">0</div>
          <div class="pomo-stat-lbl">üçÖ Today</div>
        </div>
        <div class="pomo-stat">
          <div class="pomo-stat-val" id="pomo-focus-time">0m</div>
          <div class="pomo-stat-lbl">‚è± Focused</div>
        </div>
        <div class="pomo-stat">
          <div class="pomo-stat-val" id="pomo-streak">0</div>
          <div class="pomo-stat-lbl">üî• Streak</div>
        </div>
      </div>

      <!-- Task picker -->
      <div class="pomo-task-section">
        <span class="pomo-task-label">Working on</span>
        <select class="pomo-task-pick" id="pomo-task-select" onchange="selectPomoTask()">
          <option value="">‚Äî Pick a task from today ‚Äî</option>
        </select>
        <div class="pomo-active-task" id="pomo-active-task">
          <div class="pomo-active-dot" id="pomo-active-dot" style="background:#FF6B6B;"></div>
          <div class="pomo-active-text" id="pomo-active-text"></div>
        </div>
      </div>

      <!-- Settings -->
      <div class="pomo-settings">
        <div class="pomo-settings-title">‚öôÔ∏è Timer Settings</div>
        <div class="pomo-setting-row">
          <span class="pomo-setting-lbl">üçÖ Focus duration (min)</span>
          <input class="pomo-setting-input" type="number" id="pomo-set-focus" value="25" min="1" max="90" onchange="applyPomoSettings()">
        </div>
        <div class="pomo-setting-row">
          <span class="pomo-setting-lbl">‚òï Short break (min)</span>
          <input class="pomo-setting-input" type="number" id="pomo-set-short" value="5" min="1" max="30" onchange="applyPomoSettings()">
        </div>
        <div class="pomo-setting-row">
          <span class="pomo-setting-lbl">üõå Long break (min)</span>
          <input class="pomo-setting-input" type="number" id="pomo-set-long" value="15" min="5" max="60" onchange="applyPomoSettings()">
        </div>
        <div class="pomo-setting-row">
          <span class="pomo-setting-lbl">üîÅ Long break after (sessions)</span>
          <input class="pomo-setting-input" type="number" id="pomo-set-interval" value="4" min="2" max="8" onchange="applyPomoSettings()">
        </div>
      </div>

      <!-- Session History -->
      <div class="pomo-history" id="pomo-history-section" style="display:none;">
        <span class="pomo-task-label">Today's sessions</span>
        <div id="pomo-history-list"></div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê MOBILE BOTTOM NAV ‚ïê‚ïê -->
  <nav class="mobile-nav">
    <div class="mobile-nav-inner">
      <button class="mobile-nav-btn active" id="mob-tab-planner" onclick="showPage('planner')">
        <span class="mn-icon">üìÖ</span>
        <span class="mn-label">Planner</span>
      </button>
      <button class="mobile-nav-btn" id="mob-tab-dashboard" onclick="showPage('dashboard')">
        <span class="mn-icon">üìä</span>
        <span class="mn-label">Dashboard</span>
      </button>


      <button class="mobile-nav-btn" id="mob-tab-pomodoro" onclick="showPage('pomodoro')" style="position:relative;">
        <span class="mn-icon">üçÖ</span>
        <span class="mn-label" style="color:inherit;">Focus</span>
        <span class="pomo-running-dot" id="pomo-dot-mob"></span>
      </button>
      <button class="mobile-nav-btn" id="mob-tab-boards" onclick="showPage('boards')">
        <span class="mn-icon">üóÇÔ∏è</span>
        <span class="mn-label">Boards</span>
      </button>
      <button class="mobile-nav-btn" id="mob-tab-habits" onclick="showPage('habits')">
        <span class="mn-icon">üéØ</span>
        <span class="mn-label">Habits</span>
      </button>
    </div>
  </nav>


  <!-- ‚ïê‚ïê BOARDS PAGE ‚ïê‚ïê -->
  <div class="page" id="page-boards">
    <div class="boards-layout">

      <!-- Boards list view -->
      <div id="boards-list-view">
        <div class="boards-header">
          <div>
            <div class="boards-page-title">üóÇÔ∏è My Boards</div>
            <div class="boards-page-sub">Collaborate with your team in real time</div>
          </div>
          <button class="new-board-btn" onclick="openNewBoardModal()">+ New Board</button>
        </div>
        <div class="boards-grid" id="boards-grid"></div>
      </div>

      <!-- Single board (kanban) view -->
      <div class="board-view" id="board-view">
        <div class="board-topbar">
          <button class="boards-back" onclick="closeBoard()">‚Üê All Boards</button>
          <div class="board-view-title" id="board-view-title">Board</div>
          <div class="board-members-row" id="board-members-row"></div>
          <button class="board-invite-btn" id="board-invite-btn" onclick="openInviteModal()">üë• Invite</button>
          <button class="board-invite-btn" id="board-delete-btn" onclick="deleteBoardFromView()" style="border-color:#FF6B6B;color:#FF6B6B;display:none;">üóë Delete Board</button>
        </div>
        <div class="board-columns-wrap" id="board-columns-wrap"></div>
      </div>

    </div>
  </div>

  <!-- NEW BOARD MODAL -->
  <div class="modal-overlay" id="new-board-modal">
    <div class="modal">
      <h3>Create New Board</h3>
      <div class="field"><label>Board Name</label><input id="nb-name" placeholder="e.g. Product Roadmap, Team Sprint..."></div>
      <div class="field"><label>Color Theme</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;" id="nb-colors">
          <div class="nb-color active" data-color="linear-gradient(135deg,#FF6B6B,#FF9F43)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#FF6B6B,#FF9F43);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
          <div class="nb-color" data-color="linear-gradient(135deg,#45aaf2,#26de81)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#45aaf2,#26de81);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
          <div class="nb-color" data-color="linear-gradient(135deg,#a29bfe,#fd79a8)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#a29bfe,#fd79a8);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
          <div class="nb-color" data-color="linear-gradient(135deg,#1A1208,#2d2015)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#1A1208,#2d2015);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
          <div class="nb-color" data-color="linear-gradient(135deg,#26de81,#45aaf2)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#26de81,#45aaf2);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
          <div class="nb-color" data-color="linear-gradient(135deg,#f0c040,#FF9F43)" style="width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#f0c040,#FF9F43);cursor:pointer;border:3px solid transparent;transition:all .2s;"></div>
        </div>
      </div>
      <div class="modal-btns">
        <button class="m-cancel" onclick="document.getElementById('new-board-modal').classList.remove('show')">Cancel</button>
        <button class="m-save" onclick="createBoard()">Create Board ‚ú¶</button>
      </div>
    </div>
  </div>

  <!-- INVITE MODAL -->
  <div class="modal-overlay" id="invite-modal">
    <div class="modal">
      <h3>üë• Invite Members</h3>
      <input class="invite-input" id="invite-email" placeholder="Enter email address..." type="email">
      <button class="m-save" style="width:100%;margin-bottom:8px;" onclick="inviteMember()">Send Invite</button>
      <div class="members-list" id="members-list"></div>
      <div class="modal-btns" style="margin-top:16px;">
        <button class="m-cancel" onclick="document.getElementById('invite-modal').classList.remove('show')">Done</button>
      </div>
    </div>
  </div>

  <!-- CARD DETAIL MODAL -->
  <div class="modal-overlay" id="card-modal">
    <div class="modal" style="max-width:480px;position:relative;">
      <button class="task-modal-close" onclick="closeCardModal()">√ó</button>
      <input class="card-modal-title-input" id="card-modal-title" placeholder="Card title...">
      <div class="field"><label>Notes</label><textarea class="notes-textarea" id="card-modal-notes" placeholder="Add details, links, context..." style="min-height:80px;"></textarea></div>
      <div class="field"><label>Priority</label>
        <select id="card-modal-pri">
          <option value="high">üî¥ High</option>
          <option value="medium" selected>üü° Medium</option>
          <option value="low">üü¢ Low</option>
        </select>
      </div>
      <div class="field"><label>Assign to</label>
        <select id="card-modal-assignee"><option value="">‚Äî Unassigned ‚Äî</option></select>
      </div>
      <div class="modal-btns">
        <span id="card-modal-del-wrap"></span>
        <button class="m-save" onclick="saveCard()">Save Card ‚ú¶</button>
      </div>
    </div>
  </div>


  <!-- ‚ïê‚ïê HABITS PAGE ‚ïê‚ïê -->
  <div class="page" id="page-habits">
    <div class="habits-layout">
      <div class="habits-header">
        <div class="habits-title-wrap">
          <div class="habits-title">üéØ Habit Tracker</div>
          <div class="habits-subtitle">Build consistency one day at a time</div>
        </div>
        <button class="add-habit-btn" onclick="openAddHabitModal()">+ New Habit</button>
      </div>
      <div id="habits-grid-container"></div>
    </div>
  </div>

  <!-- ADD HABIT MODAL -->
  <div class="modal-overlay" id="add-habit-modal">
    <div class="modal">
      <h3>Add New Habit</h3>
      <div class="field"><label>Habit Name</label><input id="habit-name-input" placeholder="e.g. Morning Run, Read 20 min..."></div>
      <div class="field">
        <label>Pick an Emoji</label>
        <div class="habit-emoji-picker" id="habit-emoji-picker">
          <button class="hep-btn" data-emoji="üèÉ">üèÉ</button>
          <button class="hep-btn" data-emoji="üìö">üìö</button>
          <button class="hep-btn" data-emoji="üíß">üíß</button>
          <button class="hep-btn" data-emoji="üßò">üßò</button>
          <button class="hep-btn" data-emoji="üí™">üí™</button>
          <button class="hep-btn" data-emoji="ü•ó">ü•ó</button>
          <button class="hep-btn" data-emoji="üò¥">üò¥</button>
          <button class="hep-btn active" data-emoji="üéØ">üéØ</button>
          <button class="hep-btn" data-emoji="‚úçÔ∏è">‚úçÔ∏è</button>
          <button class="hep-btn" data-emoji="üéµ">üéµ</button>
          <button class="hep-btn" data-emoji="üß†">üß†</button>
          <button class="hep-btn" data-emoji="‚òÄÔ∏è">‚òÄÔ∏è</button>
          <button class="hep-btn" data-emoji="üö¥">üö¥</button>
          <button class="hep-btn" data-emoji="üçé">üçé</button>
          <button class="hep-btn" data-emoji="üßπ">üßπ</button>
          <button class="hep-btn" data-emoji="üìù">üìù</button>
          <button class="hep-btn" data-emoji="üíä">üíä</button>
          <button class="hep-btn" data-emoji="üôè">üôè</button>
          <button class="hep-btn" data-emoji="üõÅ">üõÅ</button>
          <button class="hep-btn" data-emoji="üìµ">üìµ</button>
        </div>
      </div>
      <div class="field">
        <label>Frequency</label>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <button class="hfreq-btn" data-freq="daily" style="flex:1;padding:9px;border-radius:9px;border:2px solid var(--border);background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;">üìÖ Daily</button>
          <button class="hfreq-btn" data-freq="weekly" style="flex:1;padding:9px;border-radius:9px;border:2px solid var(--border);background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;">üìÜ Weekly</button>

        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px;" id="freq-hint">Shows in all views every day</div>
      </div>
      <div class="modal-btns">
        <button class="m-cancel" onclick="document.getElementById('add-habit-modal').classList.remove('show')">Cancel</button>
        <button class="m-save" onclick="saveNewHabit()">Add Habit ‚ú¶</button>
      </div>
    </div>
  </div>

</div><!-- /#app -->

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-badge" id="modal-badge"></div>
    <h3>Add New Task</h3>
    <div class="field"><label>Task Name</label><input id="m-text" placeholder="What needs to be done?" autocomplete="off"></div>
    <div class="field"><label>Notes (optional)</label><textarea class="notes-textarea" id="m-notes" placeholder="Extra details, links, reminders..." style="min-height:60px;"></textarea></div>
    <div class="field" style="position:relative;">
      <label>Category</label>
      <select id="m-cat" onchange="toggleCustomCat('m-custom-cat-row','m-cat')">
        <option value="work">üíº Work</option>
        <option value="personal">üè† Personal</option>
        <option value="shopping">üõí Shopping</option>
        <option value="health">üí™ Health</option>
        <option value="custom">‚úèÔ∏è Custom...</option>
      </select>
      <div class="custom-cat-row" id="m-custom-cat-row">
        <input class="custom-cat-input" id="m-custom-cat-text" placeholder="e.g. Finance, Family, Gym..." maxlength="20">
        <button class="custom-cat-emoji" id="m-custom-cat-emoji" onclick="toggleEmojiPicker('m-emoji-picker')" type="button">üè∑Ô∏è</button>
        <div class="emoji-picker" id="m-emoji-picker">
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üìö')">üìö</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üéµ')">üéµ</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üé®')">üé®</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üí∞')">üí∞</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üèãÔ∏è')">üèãÔ∏è</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','‚úàÔ∏è')">‚úàÔ∏è</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üçï')">üçï</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üåø')">üåø</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üéÆ')">üéÆ</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üê∂')">üê∂</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üë®‚Äçüë©‚Äçüëß')">üë®‚Äçüë©‚Äçüëß</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üîß')">üîß</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üì∑')">üì∑</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üßò')">üßò</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üéØ')">üéØ</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üí°')">üí°</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üåç')">üåç</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üéÅ')">üéÅ</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','‚öΩ')">‚öΩ</span>
          <span class="emoji-opt" onclick="pickEmoji('m-custom-cat-emoji','m-emoji-picker','üéì')">üéì</span>
        </div>
      </div>
    </div>
    <div class="field"><label>Priority</label><select id="m-pri"><option value="high">üî¥ High</option><option value="medium" selected>üü° Medium</option><option value="low">üü¢ Low</option></select></div>
    <div class="field">
      <div class="recur-row">
        <label>üîÅ Recurring task?</label>
        <label class="toggle"><input type="checkbox" id="m-recur-toggle" onchange="toggleRecurSelect()"><span class="toggle-slider"></span></label>
      </div>
      <select class="recur-select" id="m-recur-freq" style="margin-top:8px;width:100%;">
        <option value="daily">Every day</option>
        <option value="weekly">Every week (same day)</option>
        <option value="monday">Every Monday</option>
        <option value="tuesday">Every Tuesday</option>
        <option value="wednesday">Every Wednesday</option>
        <option value="thursday">Every Thursday</option>
        <option value="friday">Every Friday</option>
        <option value="saturday">Every Saturday</option>
        <option value="sunday">Every Sunday</option>
      </select>
      <div class="recur-select show" id="m-recur-duration-row" style="margin-top:8px;display:none;">
        <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px;">Duration</label>
        <select id="m-recur-duration" style="width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:6px 10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--ink);outline:none;">
          <option value="forever">Forever (until I delete it)</option>
          <option value="7">7 days</option>
          <option value="14">14 days</option>
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
    </div>
    <div class="modal-btns"><button class="m-cancel" id="m-cancel">Cancel</button><button class="m-save" id="m-save">Add Task ‚ú¶</button></div>
  </div>
</div>

<!-- TASK DETAIL MODAL -->
<div class="modal-overlay" id="task-modal">
  <div class="modal" style="position:relative;">
    <button class="task-modal-close" onclick="closeTaskModal()">√ó</button>
    <div class="modal-badge" id="task-modal-badge"></div>
    <div class="task-modal-title" id="task-modal-title"></div>
    <div class="task-modal-meta" id="task-modal-meta"></div>
    <span class="notes-label">üìù Notes</span>
    <textarea class="notes-textarea" id="task-modal-notes" placeholder="Add details, links, reminders..."></textarea>
    <div class="recur-row" style="margin-top:12px;">
      <label style="font-size:12px;font-weight:600;color:var(--ink);">üîÅ Recurring task?</label>
      <label class="toggle"><input type="checkbox" id="task-modal-recur-toggle" onchange="toggleTaskModalRecurSelect()"><span class="toggle-slider"></span></label>
    </div>
    <select class="recur-select" id="task-modal-recur-freq" style="margin-top:8px;width:100%;">
      <option value="daily">Every day</option>
      <option value="weekly">Every week (same day)</option>
      <option value="monday">Every Monday</option>
      <option value="tuesday">Every Tuesday</option>
      <option value="wednesday">Every Wednesday</option>
      <option value="thursday">Every Thursday</option>
      <option value="friday">Every Friday</option>
      <option value="saturday">Every Saturday</option>
      <option value="sunday">Every Sunday</option>
    </select>
    <div id="task-modal-duration-row" style="margin-top:8px;display:none;">
      <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px;">Duration</label>
      <select id="task-modal-recur-duration" style="width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:6px 10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--ink);outline:none;">
        <option value="forever">Forever (until I delete it)</option>
        <option value="7">7 days</option>
        <option value="14">14 days</option>
        <option value="30">30 days</option>
        <option value="60">60 days</option>
        <option value="90">90 days</option>
      </select>
    </div>
    <button class="task-modal-save" onclick="saveTaskModal()">üíæ Save Changes</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- OFFLINE BAR -->
<div class="offline-bar" id="offline-bar">üì° You are offline ‚Äî your tasks are saved locally and will sync when you reconnect</div>

<!-- PWA INSTALL BANNER -->
<div class="pwa-banner" id="pwa-banner">
  <div class="pwa-banner-icon">üìÖ</div>
  <div class="pwa-banner-text">
    <div class="pwa-banner-title">Install WeekFlow</div>
    <div class="pwa-banner-sub">Add to home screen for the best experience</div>
  </div>
  <button class="pwa-banner-btn" id="pwa-install-btn">Install</button>
  <button class="pwa-banner-close" id="pwa-banner-close">√ó</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut,signInWithEmailAndPassword,createUserWithEmailAndPassword,GoogleAuthProvider,signInWithPopup,updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,onSnapshot,collection,getDocs,query,where,deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üî• FIREBASE CONFIG ‚Äî weekflow-8e05f
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyD5AvjwHxOvBxRdXqKlkFUzMXL6GHftGIs",
  authDomain: "weekflow-8e05f.firebaseapp.com",
  projectId: "weekflow-8e05f",
  storageBucket: "weekflow-8e05f.firebasestorage.app",
  messagingSenderId: "929942517807",
  appId: "1:929942517807:web:59d28702ebefeb354d6eda",
  measurementId: "G-94J8GM807D"
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DAYS      = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const DAYS_FULL = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const DAY_COLORS= ['mon','tue','wed','thu','fri','sat','sun'];
const DAY_COLOR_VALS=['#FF6B6B','#FF9F43','#f0c040','#26de81','#45aaf2','#a29bfe','#fd79a8'];
const CAT_COLORS= {work:'#45aaf2',personal:'#26de81',shopping:'#f0c040',health:'#fd79a8',custom:'#a29bfe'};
const QUOTES = [
  {text:"The secret of getting ahead is getting started.",author:"Mark Twain"},
  {text:"Focus on being productive instead of busy.",author:"Tim Ferriss"},
  {text:"It always seems impossible until it's done.",author:"Nelson Mandela"},
  {text:"Done is better than perfect.",author:"Sheryl Sandberg"},
  {text:"Small daily improvements lead to stunning results.",author:"Robin Sharma"},
  {text:"Action is the foundational key to all success.",author:"Pablo Picasso"},
];
const MOTIVS = [
  {min:100,emoji:'üèÜ',text:'Perfect week! You crushed it!',sub:'100% completion ‚Äî absolutely legendary.'},
  {min:80, emoji:'üéâ',text:'Amazing work this week!',sub:'Keep this momentum going!'},
  {min:60, emoji:'üí™',text:'Solid progress!',sub:'More than halfway through ‚Äî keep pushing!'},
  {min:40, emoji:'üìà',text:'Good start ‚Äî keep going!',sub:'Every completed task counts.'},
  {min:1,  emoji:'üå±',text:'You\'ve started ‚Äî that\'s what matters!',sub:'Consistency builds habits. Keep at it!'},
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let weekOffset  = 0;
let openDay     = null;
let weekData    = {};
let allWeekData = {};
let templates   = [];
let notifSettings = {morning:false,weekly:false,complete:false,time:'08:00'};
let notifLog    = [];
let notifInterval = null;
let unsubWeek   = null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getMon(off=0){const n=new Date(),d=n.getDay(),diff=d===0?-6:1-d,m=new Date(n);m.setDate(n.getDate()+diff+off*7);m.setHours(0,0,0,0);return m;}
function getWeekDates(off=0){const m=getMon(off);return Array.from({length:7},(_,i)=>{const d=new Date(m);d.setDate(m.getDate()+i);return d;});}
function weekKey(off=0){return getMon(off).toISOString().slice(0,10);}
function isToday(date){const n=new Date();return date.getDate()===n.getDate()&&date.getMonth()===n.getMonth()&&date.getFullYear()===n.getFullYear();}
function catIcon(cat,task){if(cat==='custom')return(task&&task.catEmoji)||'üè∑Ô∏è';return{work:'üíº',personal:'üè†',shopping:'üõí',health:'üí™'}[cat]||'üè∑Ô∏è';}
function catName(cat,task){if(cat==='custom')return(task&&task.catLabel)||'Custom';return cat;}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
function showSaving(on,err=false){const d=document.getElementById('saving-dot');d.style.display=on?'inline-block':'none';d.className='saving-dot'+(err?' error':'');}

// ‚îÄ‚îÄ Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function weekRef(uid,wk){return doc(db,'users',uid,'weeks',wk);}
function userDocRef(uid){return doc(db,'users',uid);}

async function saveDay(dayIdx,tasks){
  const wk=weekKey(weekOffset); showSaving(true);
  try{await setDoc(weekRef(currentUser.uid,wk),{days:{[dayIdx]:tasks}},{merge:true});showSaving(false);}
  catch(e){showSaving(true,true);showToast('‚ö†Ô∏è Save failed. Check connection.');}
}

async function loadUserMeta(){
  const snap=await getDoc(userDocRef(currentUser.uid));
  if(snap.exists()){
    const d=snap.data();
    templates=d.templates||[];
    notifSettings=d.notifSettings||notifSettings;
    notifLog=d.notifLog||[];
    recurringTasks=d.recurringTasks||[];
    applyNotifSettings();
  }
}

async function saveUserMeta(){
  await setDoc(userDocRef(currentUser.uid),{templates,notifSettings,notifLog,recurringTasks},{merge:true});
}

async function loadAllWeeks(){
  const colRef=collection(db,'users',currentUser.uid,'weeks');
  const snap=await getDocs(colRef);
  allWeekData={};
  snap.forEach(d=>{ allWeekData[d.id]=d.data().days||{}; });
}

function listenWeek(wk){
  if(unsubWeek)unsubWeek();
  unsubWeek=onSnapshot(weekRef(currentUser.uid,wk),async snap=>{
    weekData=snap.exists()?(snap.data().days||{}):{};;
    await injectRecurringTasks(weekData);
    render(); checkMotivation();
  });
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchTab=function(tab){
  document.getElementById('tab-login').className='auth-tab'+(tab==='login'?' active':'');
  document.getElementById('tab-signup').className='auth-tab'+(tab==='signup'?' active':'');
  document.getElementById('form-login').style.display=tab==='login'?'':'none';
  document.getElementById('form-signup').style.display=tab==='signup'?'':'none';
  hideErr();
};
function showErr(m){const e=document.getElementById('auth-error');e.textContent=m;e.classList.add('show');}
function hideErr(){document.getElementById('auth-error').classList.remove('show');}

window.emailLogin=async function(){
  const e=document.getElementById('login-email').value.trim(),p=document.getElementById('login-pass').value;
  if(!e||!p){showErr('Please fill all fields.');return;}hideErr();
  try{await signInWithEmailAndPassword(auth,e,p);}catch(err){showErr(fErr(err.code));}
};
window.emailSignup=async function(){
  const n=document.getElementById('signup-name').value.trim(),e=document.getElementById('signup-email').value.trim(),p=document.getElementById('signup-pass').value;
  if(!n||!e||!p){showErr('Please fill all fields.');return;}
  if(p.length<6){showErr('Password must be 6+ characters.');return;}hideErr();
  try{const c=await createUserWithEmailAndPassword(auth,e,p);await updateProfile(c.user,{displayName:n});}catch(err){showErr(fErr(err.code));}
};
window.googleLogin=async function(){
  hideErr();try{await signInWithPopup(auth,new GoogleAuthProvider());}catch(err){if(err.code!=='auth/popup-closed-by-user')showErr(fErr(err.code));}
};
window.logout=async function(){if(unsubWeek)unsubWeek();stopNotifTimer();await signOut(auth);};
function fErr(c){return({'auth/user-not-found':'No account found.','auth/wrong-password':'Incorrect password.','auth/email-already-in-use':'Email already registered.','auth/invalid-email':'Invalid email address.','auth/weak-password':'Password must be 6+ characters.','auth/too-many-requests':'Too many attempts. Try later.'}[c])||'Something went wrong.';}

// ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth,async user=>{
  document.getElementById('loading').classList.add('hidden');
  if(user){
    currentUser=user;
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('tb-name').textContent=name;
    const av=document.getElementById('tb-avatar');
    av.innerHTML=user.photoURL?`<img src="${user.photoURL}">`:(name[0].toUpperCase());
    await loadUserMeta();
    await loadAllWeeks();
    listenWeek(weekKey(0));
    renderTemplateChips();
    startNotifTimer();
    renderDashboard();
  } else {
    currentUser=null;weekData={};allWeekData={};templates=[];
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app').classList.remove('visible');
  }
});

// ‚îÄ‚îÄ Page switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showPage=function(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tb-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-btn').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('tab-'+page).classList.add('active');
  const mobTab=document.getElementById('mob-tab-'+page);
  if(mobTab)mobTab.classList.add('active');
  // Show/hide week nav
  document.querySelector('.tb-week-nav').style.display=(page==='planner')?'':'none';
  const mwb=document.getElementById('mobile-week-bar');
  if(mwb)mwb.style.display=(page==='planner')?'flex':'none';
  if(page==='dashboard'){renderDashboard();}
  if(page==='pomodoro'){renderPomoTaskPicker();}
  if(page==='boards'){renderBoardsList();}
  if(page==='habits'){renderHabitsPage();}
};

// ‚ïê‚ïê RENDER PLANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const wk=weekKey(weekOffset),dates=getWeekDates(weekOffset);
  const mon=getMon(weekOffset),sun=dates[6];
  const fmt=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const wkLabelText=`${fmt(mon)} ‚Äî ${fmt(sun)}, ${sun.getFullYear()}`;
  document.getElementById('week-label').textContent=wkLabelText;
  const mobLbl=document.getElementById('mob-week-label');
  if(mobLbl)mobLbl.textContent=wkLabelText;

  let total=0,done=0,busy=0,busyIdx=-1;
  for(let i=0;i<7;i++){const t=weekData[i]||[];total+=t.length;done+=t.filter(x=>x.done).length;if(t.length>busy){busy=t.length;busyIdx=i;}}
  document.getElementById('s-total').textContent=total;
  document.getElementById('s-done').textContent=done;
  document.getElementById('s-pending').textContent=total-done;
  const pct=total?Math.round(done/total*100):0;
  document.getElementById('s-pct').textContent=pct+'%';
  document.getElementById('s-bar').style.width=pct+'%';
  document.getElementById('s-busiest').textContent=busyIdx>=0&&busy>0?DAYS[busyIdx]:'‚Äî';
  document.getElementById('s-busiest-sub').textContent=busyIdx>=0&&busy>0?busy+' tasks':'';

  // Header
  const hRow=document.getElementById('header-row');hRow.innerHTML='';
  dates.forEach((date,i)=>{
    const tasks=weekData[i]||[],dc=tasks.filter(t=>t.done).length;
    const th=document.createElement('th');
    th.className=`col-${DAY_COLORS[i]} ${isToday(date)?'today-col':''}`;
    th.innerHTML=`<div class="day-header"><div class="day-name">${DAYS[i]}</div><div class="day-date">${date.getDate()}</div><div class="day-month">${date.toLocaleDateString('en-US',{month:'short'})}</div><div class="day-count">${tasks.length} task${tasks.length!==1?'s':''} ¬∑ ${dc} done</div></div>`;
    hRow.appendChild(th);
  });

  // Body with drag & drop
  const bRow=document.getElementById('body-row');bRow.innerHTML='';
  dates.forEach((date,i)=>{
    const tasks=weekData[i]||[];
    const td=document.createElement('td');
    td.className=`col-${DAY_COLORS[i]} ${isToday(date)?'today-col':''}`;
    const cell=document.createElement('div');
    cell.className='day-cell';
    cell.dataset.day=i;

    // ‚îÄ‚îÄ Mobile day label (visible only on mobile) ‚îÄ‚îÄ
    const todayClass = isToday(date) ? 'today-label' : '';
    const dayColor = DAY_COLOR_VALS[i];
    const tasks_count = tasks.length;
    const done_count = tasks.filter(t=>t.done).length;
    const mobileLbl = document.createElement('div');
    mobileLbl.className = `mobile-day-label ${todayClass}`;
    mobileLbl.innerHTML = `
      <div class="mdl-left">
        <div class="mdl-num" style="${!isToday(date)?'color:'+dayColor:''}">${date.getDate()}</div>
        <div>
          <div class="mdl-day" style="${!isToday(date)?'color:'+dayColor:''}">${DAYS_FULL[i]}</div>
          <div class="mdl-date">${date.toLocaleDateString('en-US',{month:'long',year:'numeric'})} ¬∑ ${tasks_count} task${tasks_count!==1?'s':''} ¬∑ ${done_count} done</div>
        </div>
      </div>
      <button class="mdl-add" data-day="${i}" title="Add task">+</button>
    `;
    cell.appendChild(mobileLbl);

    // Drop zone
    cell.addEventListener('dragover',e=>{e.preventDefault();cell.classList.add('drag-over');});
    cell.addEventListener('dragleave',()=>cell.classList.remove('drag-over'));
    cell.addEventListener('drop',e=>{
      e.preventDefault();cell.classList.remove('drag-over');
      const srcDay=parseInt(e.dataTransfer.getData('srcDay'));
      const taskId=e.dataTransfer.getData('taskId');
      if(srcDay===i)return;
      const srcTasks=[...(weekData[srcDay]||[])];
      const tgtTasks=[...(weekData[i]||[])];
      const idx=srcTasks.findIndex(x=>x.id===taskId);
      if(idx<0)return;
      const [moved]=srcTasks.splice(idx,1);
      tgtTasks.push(moved);
      weekData[srcDay]=srcTasks;weekData[i]=tgtTasks;
      saveDay(srcDay,srcTasks);saveDay(i,tgtTasks);
      render();showToast(`‚úÖ Moved to ${DAYS_FULL[i]}`);
    });

    tasks.forEach(task=>{
      const item=document.createElement('div');
      item.className=`cell-task p-${task.priority} ${task.done?'done-task':''}`;
      item.draggable=true;
      item.dataset.id=task.id;
      item.innerHTML=`
        <button class="ct-check" data-id="${task.id}" data-day="${i}">${task.done?'‚úì':''}</button>
        <div class="ct-body" style="cursor:pointer;" data-open-id="${task.id}" data-open-day="${i}">
          <div class="ct-text">${task.text}</div>
          ${task.notes?`<div class="notes-preview">üìù ${task.notes}</div>`:''}
          <div class="ct-meta">
            <span class="ct-tag ${task.cat}" ${task.cat==='custom'?`style="background:rgba(162,155,254,.15);color:#6c5ce7;"`:""}>${catIcon(task.cat,task)} ${catName(task.cat,task)}</span>
            ${task.priority==='high'?'<span style="font-size:9px;color:#FF6B6B;font-weight:700;">‚óè HIGH</span>':''}
            ${task.recurring?`<span class="ct-recur">üîÅ ${task.recurring==='daily'?'Daily':task.recurring==='weekly'?'Weekly':task.recurring.charAt(0).toUpperCase()+task.recurring.slice(1)+'s'}</span>`:''}
          </div>
        </div>
        <button class="ct-del" data-id="${task.id}" data-day="${i}">‚úï</button>`;
      item.addEventListener('dragstart',e=>{
        item.classList.add('dragging');
        e.dataTransfer.setData('taskId',task.id);
        e.dataTransfer.setData('srcDay',i);
      });
      item.addEventListener('dragend',()=>item.classList.remove('dragging'));

      // ‚úÖ FEATURE 17 ‚Äî SWIPE TO DELETE
      const swipeWrap=document.createElement('div');
      swipeWrap.className='swipe-wrap';
      const deleteBg=document.createElement('div');
      deleteBg.className='swipe-delete-bg';
      deleteBg.innerHTML='<span>üóëÔ∏è</span>';
      swipeWrap.appendChild(deleteBg);
      swipeWrap.appendChild(item);

      let touchStartX=0,touchCurrentX=0,touchStartY=0,didSwipe=false;
      item.addEventListener('touchstart',e=>{
        touchStartX=e.touches[0].clientX;
        touchStartY=e.touches[0].clientY;
        touchCurrentX=e.touches[0].clientX;
        didSwipe=false;
      },{passive:true});
      item.addEventListener('touchmove',e=>{
        touchCurrentX=e.touches[0].clientX;
        const diffX=touchCurrentX-touchStartX;
        const diffY=e.touches[0].clientY-touchStartY;
        // Only activate swipe if moving LEFT and horizontal movement dominates
        if(diffX < -15 && Math.abs(diffX) > Math.abs(diffY)){
          didSwipe=true;
          const move=Math.max(diffX,-90);
          item.style.transform=`translateX(${move}px)`;
          deleteBg.style.opacity=Math.min(Math.abs(move)/80,1);
        }
      },{passive:true});
      item.addEventListener('touchend',()=>{
        const diff=touchCurrentX-touchStartX;
        if(didSwipe && diff<-70){
          // Confirmed swipe-to-delete
          haptic([50,30,100]);
          item.style.transform='translateX(-100%)';
          item.style.opacity='0';
          setTimeout(async ()=>{
            // If recurring task instance ‚Äî add date to skippedDates so it doesn't reappear
            if(task.sourceRecurId){
              const dates=getWeekDates(weekOffset);
              const dayKey=dates[i].toISOString().slice(0,10);
              const recIdx=recurringTasks.findIndex(r=>r.id===task.sourceRecurId);
              if(recIdx>=0){
                const skipped=new Set(recurringTasks[recIdx].skippedDates||[]);
                skipped.add(dayKey);
                recurringTasks[recIdx].skippedDates=[...skipped];
                await saveUserMeta();
              }
            }
            const tasks=(weekData[i]||[]).filter(x=>x.id!==task.id);
            weekData[i]=tasks;await saveDay(i,tasks);render();
            showToast('üóëÔ∏è Task deleted');
          },280);
        } else {
          // Normal tap or short swipe ‚Äî snap back, do NOT delete
          item.style.transition='transform 0.2s ease';
          item.style.transform='';
          deleteBg.style.opacity='0';
          setTimeout(()=>{ item.style.transition=''; },200);
        }
        touchStartX=0;touchCurrentX=0;touchStartY=0;didSwipe=false;
      },{passive:true});

      cell.appendChild(swipeWrap);
    });

    const addBtn=document.createElement('button');
    addBtn.className='add-task-btn';addBtn.dataset.day=i;
    addBtn.innerHTML='<span>+</span> Add task';
    cell.appendChild(addBtn);
    td.appendChild(cell);bRow.appendChild(td);
  });

  // Events
  // Open task detail modal when clicking task body
  document.querySelectorAll('[data-open-id]').forEach(body=>{
    body.addEventListener('click',e=>{
      e.stopPropagation();
      const taskId=body.dataset.openId, dayI=parseInt(body.dataset.openDay);
      const task=(weekData[dayI]||[]).find(t=>t.id===taskId);
      if(task) openTaskModal(task, dayI);
    });
  });

  document.querySelectorAll('.ct-check').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const dayI=parseInt(btn.dataset.day),id=btn.dataset.id;
      const tasks=[...(weekData[dayI]||[])];
      const t=tasks.find(x=>x.id===id);
      if(!t)return;
      t.done=!t.done;weekData[dayI]=tasks;
      haptic(t.done?[40,20,40]:[20]);
      saveDay(dayI,tasks);render();
      // Check if all done for the day
      if(t.done&&tasks.every(x=>x.done)&&tasks.length>0){
        if(notifSettings.complete)sendNotif('üéâ All done!',`You completed all ${tasks.length} tasks for ${DAYS_FULL[dayI]}!`);
        spawnConfetti();
      }
      allWeekData[weekKey(weekOffset)]=weekData;
    });
  });
  document.querySelectorAll('.ct-del').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const dayI=parseInt(btn.dataset.day),id=btn.dataset.id;
      const task=(weekData[dayI]||[]).find(t=>t.id===id);
      // If it's a recurring task instance, add this date to skippedDates
      if(task && task.sourceRecurId){
        const dates=getWeekDates(weekOffset);
        const dayKey=dates[dayI].toISOString().slice(0,10);
        const recIdx=recurringTasks.findIndex(r=>r.id===task.sourceRecurId);
        if(recIdx>=0){
          const skipped=new Set(recurringTasks[recIdx].skippedDates||[]);
          skipped.add(dayKey);
          recurringTasks[recIdx].skippedDates=[...skipped];
          await saveUserMeta();
        }
      }
      const tasks=(weekData[dayI]||[]).filter(x=>x.id!==id);
      weekData[dayI]=tasks;await saveDay(dayI,tasks);render();showToast('üóëÔ∏è Removed');
    });
  });
  // Mobile day label + button
  document.querySelectorAll('.mdl-add').forEach(btn=>{
    btn.addEventListener('click',()=>{openDay=parseInt(btn.dataset.day);openModal(openDay);});
  });

  document.querySelectorAll('.add-task-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{openDay=parseInt(btn.dataset.day);openModal(openDay);});
  });
  updateTemplatePreview();
}

// ‚îÄ‚îÄ Motivation banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkMotivation(){
  let total=0,done=0;
  for(let i=0;i<7;i++){const t=weekData[i]||[];total+=t.length;done+=t.filter(x=>x.done).length;}
  if(!total)return;
  const pct=Math.round(done/total*100);
  const m=MOTIVS.find(x=>pct>=x.min);
  if(m&&done>0){
    document.getElementById('motiv-emoji').textContent=m.emoji;
    document.getElementById('motiv-text').textContent=m.text;
    document.getElementById('motiv-sub').textContent=`${pct}% completion ‚Äî ${m.sub}`;
    document.getElementById('motiv-banner').classList.add('show');
  }
}

// ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnConfetti(){
  const colors=['#FF6B6B','#FF9F43','#f0c040','#26de81','#45aaf2','#a29bfe','#fd79a8'];
  for(let i=0;i<60;i++){
    const el=document.createElement('div');
    el.className='confetti-piece';
    el.style.left=Math.random()*100+'vw';
    el.style.top='-10px';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay=Math.random()*1.2+'s';
    el.style.animationDuration=(1.5+Math.random())+'s';
    el.style.width=el.style.height=(6+Math.random()*10)+'px';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),3000);
  }
}

// ‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(dayIdx){
  const dates=getWeekDates(weekOffset),badge=document.getElementById('modal-badge'),color=DAY_COLOR_VALS[dayIdx];
  badge.style.background=color+'18';badge.style.color=color;badge.style.border=`1.5px solid ${color}40`;
  badge.textContent=`${DAYS_FULL[dayIdx]} ¬∑ ${dates[dayIdx].toLocaleDateString('en-US',{month:'long',day:'numeric'})}`;
  document.getElementById('m-text').value='';
  document.getElementById('m-notes').value='';
  document.getElementById('m-recur-toggle').checked=false;
  document.getElementById('m-recur-freq').classList.remove('show');
  document.getElementById('m-cat').value='work';
  document.getElementById('m-custom-cat-row').classList.remove('show');
  document.getElementById('m-custom-cat-text').value='';
  document.getElementById('m-custom-cat-emoji').textContent='üè∑Ô∏è';
  document.getElementById('modal').classList.add('show');
  setTimeout(()=>document.getElementById('m-text').focus(),100);
}

window.toggleRecurSelect = function(){
  const chk=document.getElementById('m-recur-toggle');
  const sel=document.getElementById('m-recur-freq');
  const dur=document.getElementById('m-recur-duration-row');
  sel.classList.toggle('show', chk.checked);
  dur.style.display=chk.checked?'block':'none';
};

window.toggleTaskModalRecurDuration = function(){
  const chk=document.getElementById('task-modal-recur-toggle');
  const dur=document.getElementById('task-modal-duration-row');
  if(dur) dur.style.display=chk.checked?'block':'none';
};

async function saveTask(){
  const text=document.getElementById('m-text').value.trim();
  if(!text){document.getElementById('m-text').focus();return;}
  const notes=document.getElementById('m-notes').value.trim();
  const recurOn=document.getElementById('m-recur-toggle').checked;
  const recurFreq=recurOn?document.getElementById('m-recur-freq').value:null;
  const recurDuration=recurOn?document.getElementById('m-recur-duration').value:'forever';
  const tasks=[...(weekData[openDay]||[])];
  // Handle custom category
  let catVal=document.getElementById('m-cat').value;
  let catLabel=null, catEmoji=null;
  if(catVal==='custom'){
    catLabel=document.getElementById('m-custom-cat-text').value.trim()||'Custom';
    catEmoji=document.getElementById('m-custom-cat-emoji').textContent||'üè∑Ô∏è';
    catVal='custom';
  }
  const today=new Date(); today.setHours(0,0,0,0);
  const newTask={id:uid(),text,notes,cat:catVal,catLabel,catEmoji,priority:document.getElementById('m-pri').value,done:false};
  if(recurFreq){
    newTask.recurring=recurFreq;
    newTask.recurStart=today.toISOString().slice(0,10); // start from TODAY
    newTask.recurDuration=recurDuration; // 'forever' or number of days
  }
  tasks.push(newTask);
  weekData[openDay]=tasks;
  document.getElementById('modal').classList.remove('show');
  render();await saveDay(openDay,tasks);
  if(recurFreq){ await saveRecurringTask(newTask, openDay); }
  showToast(recurFreq?'üîÅ Recurring task saved!':'‚úÖ Task saved to cloud!');
  allWeekData[weekKey(weekOffset)]=weekData;
}

document.getElementById('m-save').addEventListener('click',saveTask);
document.getElementById('m-cancel').addEventListener('click',()=>document.getElementById('modal').classList.remove('show'));
document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))document.getElementById('modal').classList.remove('show');});
document.getElementById('m-text').addEventListener('keydown',e=>{if(e.key==='Enter')saveTask();});

// ‚îÄ‚îÄ CUSTOM CATEGORY HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.toggleCustomCat = function(rowId, selectId){
  const val = document.getElementById(selectId).value;
  document.getElementById(rowId).classList.toggle('show', val==='custom');
  if(val==='custom') setTimeout(()=>document.getElementById('m-custom-cat-text').focus(),50);
};

window.toggleEmojiPicker = function(pickerId){
  document.getElementById(pickerId).classList.toggle('show');
};

window.pickEmoji = function(btnId, pickerId, emoji){
  document.getElementById(btnId).textContent=emoji;
  document.getElementById(pickerId).classList.remove('show');
};

// Close emoji picker when clicking outside
document.addEventListener('click', e=>{
  if(!e.target.closest('.custom-cat-emoji')&&!e.target.closest('.emoji-picker')){
    document.querySelectorAll('.emoji-picker').forEach(p=>p.classList.remove('show'));
  }
});

// ‚îÄ‚îÄ TASK DETAIL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let openTaskId=null, openTaskDay=null;

function openTaskModal(task, dayI){
  openTaskId=task.id; openTaskDay=dayI;
  const color=DAY_COLOR_VALS[dayI];
  const badge=document.getElementById('task-modal-badge');
  badge.style.background=color+'18';badge.style.color=color;badge.style.border=`1.5px solid ${color}40`;
  badge.textContent=DAYS_FULL[dayI];
  document.getElementById('task-modal-title').textContent=task.text;
  const catColors={work:'#45aaf2',personal:'#26de81',shopping:'#f0c040',health:'#fd79a8',custom:'#a29bfe'};
  const priColors={high:'#FF6B6B',medium:'#FF9F43',low:'#26de81'};
  document.getElementById('task-modal-meta').innerHTML=`
    <span class="task-modal-tag" style="background:${catColors[task.cat]||'#a29bfe'}20;color:${catColors[task.cat]||'#a29bfe'}">${catIcon(task.cat,task)} ${catName(task.cat,task)}</span>
    <span class="task-modal-tag" style="background:${priColors[task.priority]}20;color:${priColors[task.priority]}">‚óè ${task.priority}</span>
    ${task.done?'<span class="task-modal-tag" style="background:rgba(38,222,129,.15);color:#20bf6b">‚úì done</span>':''}
  `;
  document.getElementById('task-modal-notes').value=task.notes||'';
  const recurChk=document.getElementById('task-modal-recur-toggle');
  const recurSel=document.getElementById('task-modal-recur-freq');
  const durRow=document.getElementById('task-modal-duration-row');
  const durSel=document.getElementById('task-modal-recur-duration');
  recurChk.checked=!!task.recurring;
  recurSel.classList.toggle('show',!!task.recurring);
  if(durRow) durRow.style.display=task.recurring?'block':'none';
  if(task.recurring){ recurSel.value=task.recurring; if(durSel&&task.recurDuration) durSel.value=task.recurDuration; }
  document.getElementById('task-modal').classList.add('show');
  setTimeout(()=>document.getElementById('task-modal-notes').focus(),100);
}

window.toggleTaskModalRecurSelect = function(){
  const chk=document.getElementById('task-modal-recur-toggle');
  document.getElementById('task-modal-recur-freq').classList.toggle('show',chk.checked);
  const dur=document.getElementById('task-modal-duration-row');
  if(dur) dur.style.display=chk.checked?'block':'none';
};

window.closeTaskModal = function(){
  document.getElementById('task-modal').classList.remove('show');
  openTaskId=null; openTaskDay=null;
};

window.saveTaskModal = async function(){
  if(!openTaskId) return;
  const tasks=[...(weekData[openTaskDay]||[])];
  const idx=tasks.findIndex(t=>t.id===openTaskId);
  if(idx<0){closeTaskModal();return;}
  const notes=document.getElementById('task-modal-notes').value.trim();
  const recurOn=document.getElementById('task-modal-recur-toggle').checked;
  const recurFreq=recurOn?document.getElementById('task-modal-recur-freq').value:null;
  const recurDuration=recurOn?document.getElementById('task-modal-recur-duration').value:'forever';
  tasks[idx]={...tasks[idx],notes};
  if(recurFreq){
    tasks[idx].recurring=recurFreq;
    if(!tasks[idx].recurStart){ const t=new Date();t.setHours(0,0,0,0);tasks[idx].recurStart=t.toISOString().slice(0,10); }
    tasks[idx].recurDuration=recurDuration;
  } else {
    delete tasks[idx].recurring;
    delete tasks[idx].recurStart;
    delete tasks[idx].recurDuration;
  }
  weekData[openTaskDay]=tasks;
  await saveDay(openTaskDay,tasks);
  if(recurFreq) await saveRecurringTask(tasks[idx], openTaskDay);
  else await removeRecurringTask(openTaskId);
  render();
  closeTaskModal();
  showToast('üíæ Task updated!');
};

document.getElementById('task-modal').addEventListener('click',e=>{
  if(e.target===document.getElementById('task-modal')) closeTaskModal();
});

// ‚îÄ‚îÄ RECURRING TASKS LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Store recurring tasks in userMeta and inject them into future weeks
let recurringTasks = [];

async function saveRecurringTask(task, dayIdx){
  // Remove old version if exists
  recurringTasks = recurringTasks.filter(r=>r.id!==task.id);
  recurringTasks.push({...task, sourceDayIdx: dayIdx});
  await saveUserMeta();
}

async function removeRecurringTask(taskId){
  const before=recurringTasks.length;
  recurringTasks = recurringTasks.filter(r=>r.id!==taskId);
  if(recurringTasks.length !== before) await saveUserMeta();
}

// Called when loading a week ‚Äî inject any recurring tasks that should appear
async function injectRecurringTasks(weekDays){
  if(!recurringTasks.length) return;
  const dates = getWeekDates(weekOffset);
  const dayNames = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
  const today = new Date(); today.setHours(0,0,0,0);
  let changed = false;

  for(const rec of recurringTasks){
    // Parse start date ‚Äî never inject before this date
    const startDate = rec.recurStart ? new Date(rec.recurStart+'T00:00:00') : today;

    // Parse end date based on duration
    let endDate = null;
    if(rec.recurDuration && rec.recurDuration !== 'forever'){
      endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + parseInt(rec.recurDuration) - 1);
    }

    // Set of dates the user manually deleted this recurring task from
    const skipped = new Set(rec.skippedDates||[]);

    for(let i=0;i<7;i++){
      const dayDate = dates[i]; dayDate.setHours(0,0,0,0);
      const dayKey = dayDate.toISOString().slice(0,10);

      // Skip past days
      if(dayDate < today) continue;
      // Skip before start date
      if(dayDate < startDate) continue;
      // Skip after end date
      if(endDate && dayDate > endDate) continue;
      // Skip if user manually deleted on this date
      if(skipped.has(dayKey)) continue;

      // Check if this day matches the recurring pattern
      const shouldAppear = rec.recurring==='daily'
        ? true
        : rec.recurring==='weekly'
          ? i===rec.sourceDayIdx
          : dayNames[i]===rec.recurring;
      if(!shouldAppear) continue;

      const dayTasks = weekDays[i]||[];
      const alreadyHere = dayTasks.some(t=>t.sourceRecurId===rec.id);
      if(!alreadyHere){
        const newTask={...rec,id:uid(),sourceRecurId:rec.id,done:false};
        weekDays[i]=[...dayTasks,newTask];
        changed=true;
      }
    }
  }
  if(changed){
    for(let i=0;i<7;i++){
      if(weekDays[i]) await saveDay(i,weekDays[i]);
    }
  }
}

// ‚ïê‚ïê POMODORO TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POMO_CIRCUMFERENCE = 2 * Math.PI * 115; // 722.6

let pomoState = {
  mode: 'focus',       // 'focus' | 'short' | 'long'
  running: false,
  timeLeft: 25 * 60,   // seconds
  totalTime: 25 * 60,
  interval: null,
  sessionsToday: 0,
  focusMinutes: 0,
  streak: 0,
  selectedTaskText: '',
  history: [],          // [{mode, task, duration, time}]
  settings: { focus: 25, short: 5, long: 15, interval: 4 }
};

const POMO_COLORS = { focus: '#FF6B6B', short: '#26de81', long: '#45aaf2' };
const POMO_LABELS = { focus: 'Focus Session', short: 'Short Break', long: 'Long Break' };

window.setPomoMode = function setPomoMode(mode){
  if(pomoState.running) return; // don't switch while running
  pomoState.mode = mode;
  const mins = mode==='focus' ? pomoState.settings.focus : mode==='short' ? pomoState.settings.short : pomoState.settings.long;
  pomoState.timeLeft = mins * 60;
  pomoState.totalTime = mins * 60;
  // Update UI
  document.querySelectorAll('.pomo-mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('pomo-mode-'+mode).classList.add('active');
  document.getElementById('pomo-play-btn').style.background = POMO_COLORS[mode];
  document.getElementById('pomo-ring').style.stroke = POMO_COLORS[mode];
  document.getElementById('pomo-active-dot').style.background = POMO_COLORS[mode];
  document.getElementById('pomo-session-label').textContent = POMO_LABELS[mode];
  updatePomoDisplay();
}

window.togglePomo = function togglePomo(){
  if(pomoState.running){
    pausePomo();
  } else {
    startPomo();
  }
}

function startPomo(){
  pomoState.running = true;
  document.getElementById('pomo-play-btn').textContent = '‚è∏';
  showRunningDots(true);
  pomoState.interval = setInterval(()=>{
    pomoState.timeLeft--;
    if(pomoState.mode==='focus') pomoState.focusMinutes = (pomoState.focusMinutes*1) + (1/60);
    updatePomoDisplay();
    if(pomoState.timeLeft <= 0){
      clearInterval(pomoState.interval);
      onPomoComplete();
    }
  }, 1000);
}

function pausePomo(){
  pomoState.running = false;
  clearInterval(pomoState.interval);
  document.getElementById('pomo-play-btn').textContent = '‚ñ∂';
  showRunningDots(false);
}

window.resetPomo = function resetPomo(){
  pausePomo();
  const mins = pomoState.mode==='focus' ? pomoState.settings.focus : pomoState.mode==='short' ? pomoState.settings.short : pomoState.settings.long;
  pomoState.timeLeft = mins * 60;
  pomoState.totalTime = mins * 60;
  updatePomoDisplay();
}

window.skipPomo = function skipPomo(){
  pausePomo();
  onPomoComplete();
}

function onPomoComplete(){
  haptic([100,50,200]);
  // Log session
  if(pomoState.mode==='focus'){
    pomoState.sessionsToday++;
    pomoState.streak++;
    const mins = pomoState.settings.focus;
    pomoState.history.unshift({
      mode: 'focus',
      task: pomoState.selectedTaskText || 'Free focus',
      duration: mins,
      time: new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})
    });
    pomoState.focusMinutes = Math.round(pomoState.focusMinutes);
    // Mark linked task as done
    markPomoTaskDone();
  }
  // Send browser notification
  sendPomoNotification();
  // Auto switch to break
  if(pomoState.mode==='focus'){
    const isLong = pomoState.sessionsToday % pomoState.settings.interval === 0;
    showToast(isLong ? 'üõå Great work! Time for a long break!' : '‚òï Nice! Take a short break!');
    setTimeout(()=> setPomoMode(isLong ? 'long' : 'short'), 1200);
  } else {
    showToast('üçÖ Break over! Back to focus!');
    setTimeout(()=> setPomoMode('focus'), 1200);
  }
  updatePomoStats();
  renderPomoHistory();
  savePomoStats();
}

function updatePomoDisplay(){
  const mins = String(Math.floor(pomoState.timeLeft/60)).padStart(2,'0');
  const secs = String(pomoState.timeLeft%60).padStart(2,'0');
  document.getElementById('pomo-time').textContent = `${mins}:${secs}`;
  // Update page title when running
  if(pomoState.running) document.title = `${mins}:${secs} ‚Äî WeekFlow Focus`;
  else document.title = 'WeekFlow Pro';
  // Update ring
  const progress = pomoState.timeLeft / pomoState.totalTime;
  const offset = POMO_CIRCUMFERENCE * (1 - progress);
  document.getElementById('pomo-ring').style.strokeDashoffset = offset;
}

function updatePomoStats(){
  document.getElementById('pomo-count').textContent = pomoState.sessionsToday;
  const fm = Math.round(pomoState.sessionsToday * pomoState.settings.focus);
  document.getElementById('pomo-focus-time').textContent = fm >= 60 ? Math.round(fm/60)+'h' : fm+'m';
  document.getElementById('pomo-streak').textContent = pomoState.streak;
}

function showRunningDots(show){
  document.querySelectorAll('.pomo-running-dot').forEach(d=> d.classList.toggle('show', show));
}

function renderPomoTaskPicker(){
  const sel = document.getElementById('pomo-task-select');
  const today = new Date().getDay(); // 0=Sun
  const dayIdx = today===0 ? 6 : today-1; // convert to Mon=0
  const tasks = (weekData[dayIdx]||[]).filter(t=>!t.done);
  sel.innerHTML = '<option value="">‚Äî Pick a task from today ‚Äî</option>';
  tasks.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = t.text;
    sel.appendChild(opt);
  });
  updatePomoStats();
}

window.selectPomoTask = function selectPomoTask(){
  const sel = document.getElementById('pomo-task-select');
  const txt = sel.options[sel.selectedIndex]?.text || '';
  pomoState.selectedTaskId = sel.value;
  pomoState.selectedTaskText = sel.value ? txt : '';
  const activeEl = document.getElementById('pomo-active-task');
  const textEl = document.getElementById('pomo-active-text');
  if(sel.value){
    textEl.textContent = txt;
    activeEl.classList.add('show');
  } else {
    activeEl.classList.remove('show');
  }
}

function markPomoTaskDone(){
  if(!pomoState.selectedTaskId) return;
  const today = new Date().getDay();
  const dayIdx = today===0 ? 6 : today-1;
  const tasks = weekData[dayIdx]||[];
  const idx = tasks.findIndex(t=>t.id===pomoState.selectedTaskId);
  if(idx>=0 && !tasks[idx].done){
    tasks[idx].done = true;
    weekData[dayIdx] = tasks;
    saveDay(dayIdx, tasks);
    showToast('‚úÖ Task marked as done!');
    // Reset task picker
    pomoState.selectedTaskId = null;
    pomoState.selectedTaskText = '';
    document.getElementById('pomo-task-select').value='';
    document.getElementById('pomo-active-task').classList.remove('show');
  }
}

function renderPomoHistory(){
  const section = document.getElementById('pomo-history-section');
  const list = document.getElementById('pomo-history-list');
  if(!pomoState.history.length){ section.style.display='none'; return; }
  section.style.display='block';
  list.innerHTML = pomoState.history.slice(0,8).map(h=>`
    <div class="pomo-hist-row">
      <div class="pomo-hist-emoji">${h.mode==='focus'?'üçÖ':'‚òï'}</div>
      <div class="pomo-hist-info">
        <div class="pomo-hist-task">${h.task}</div>
        <div class="pomo-hist-time">${h.time}</div>
      </div>
      <div class="pomo-hist-dur">${h.duration}m</div>
    </div>`).join('');
}

window.applyPomoSettings = function applyPomoSettings(){
  pomoState.settings.focus   = parseInt(document.getElementById('pomo-set-focus').value)||25;
  pomoState.settings.short   = parseInt(document.getElementById('pomo-set-short').value)||5;
  pomoState.settings.long    = parseInt(document.getElementById('pomo-set-long').value)||15;
  pomoState.settings.interval= parseInt(document.getElementById('pomo-set-interval').value)||4;
  if(!pomoState.running) resetPomo();
}

async function sendPomoNotification(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') await Notification.requestPermission();
  if(Notification.permission === 'granted'){
    const msg = pomoState.mode==='focus'
      ? `üçÖ Focus session done! ${pomoState.sessionsToday} sessions today.`
      : 'üçÖ Break over ‚Äî ready to focus?';
    new Notification('WeekFlow Focus', { body: msg, icon: '/icon-192.png' });
  }
}

function savePomoStats(){
  // Save to localStorage so stats survive page refresh within the day
  const today = new Date().toDateString();
  localStorage.setItem('pomo_stats', JSON.stringify({
    date: today,
    sessionsToday: pomoState.sessionsToday,
    streak: pomoState.streak,
    history: pomoState.history,
    settings: pomoState.settings
  }));
}

function loadPomoStats(){
  try{
    const saved = JSON.parse(localStorage.getItem('pomo_stats')||'{}');
    const today = new Date().toDateString();
    if(saved.date === today){
      pomoState.sessionsToday = saved.sessionsToday||0;
      pomoState.history = saved.history||[];
      renderPomoHistory();
    }
    // Always restore settings and streak
    if(saved.streak) pomoState.streak = saved.streak;
    if(saved.settings) {
      pomoState.settings = {...pomoState.settings, ...saved.settings};
      document.getElementById('pomo-set-focus').value = pomoState.settings.focus;
      document.getElementById('pomo-set-short').value = pomoState.settings.short;
      document.getElementById('pomo-set-long').value = pomoState.settings.long;
      document.getElementById('pomo-set-interval').value = pomoState.settings.interval;
    }
    updatePomoStats();
  }catch(e){}
}

// Load stats when page initializes
document.addEventListener('DOMContentLoaded', ()=> setTimeout(loadPomoStats, 500));

// ‚ïê‚ïê WEEK NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('prev-week').addEventListener('click',()=>{weekOffset--;weekData={};listenWeek(weekKey(weekOffset));});
document.getElementById('next-week').addEventListener('click',()=>{weekOffset++;weekData={};listenWeek(weekKey(weekOffset));});
document.getElementById('today-btn').addEventListener('click',()=>{weekOffset=0;weekData={};listenWeek(weekKey(0));});

// ‚ïê‚ïê TEMPLATES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTemplatePreview(){
  const prev=document.getElementById('tmpl-preview');if(!prev)return;
  let html='';let hasAny=false;
  for(let i=0;i<7;i++){
    const tasks=weekData[i]||[];
    if(tasks.length){hasAny=true;html+=`<div class="tmpl-preview-day">${DAYS_FULL[i]}</div>`;
    tasks.forEach(t=>{html+=`<div class="tmpl-preview-task">${t.text}</div>`;});}
  }
  prev.innerHTML=hasAny?html:'<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">No tasks this week yet. Add some tasks first!</div>';
}

window.saveTemplate=async function(){
  const name=document.getElementById('tmpl-name-input').value.trim();
  if(!name){showToast('‚ö†Ô∏è Please enter a template name.');return;}
  let hasAny=false;
  for(let i=0;i<7;i++){if((weekData[i]||[]).length){hasAny=true;break;}}
  if(!hasAny){showToast('‚ö†Ô∏è Add tasks to the week first!');return;}
  const tmpl={id:uid(),name,days:{},created:new Date().toISOString()};
  for(let i=0;i<7;i++){
    if((weekData[i]||[]).length){
      tmpl.days[i]=(weekData[i]||[]).map(t=>({...t,id:uid(),done:false}));
    }
  }
  templates.push(tmpl);await saveUserMeta();
  document.getElementById('tmpl-name-input').value='';
  
  showToast('üìã Template saved!');
};



function renderTemplateChips(){
  const wrap=document.getElementById('template-chips');if(!wrap)return;
  wrap.innerHTML='';
  templates.slice(0,4).forEach(tmpl=>{
    const btn=document.createElement('button');btn.className='template-chip';
    btn.textContent='üìã '+tmpl.name;
    btn.addEventListener('click',()=>loadTemplate(tmpl.id));
    wrap.appendChild(btn);
  });
}

async function loadTemplate(id){
  const tmpl=templates.find(t=>t.id===id);if(!tmpl)return;
  if(!confirm(`Load "${tmpl.name}"? This will ADD tasks to this week (won't delete existing).`))return;
  for(const [dayIdx,tasks] of Object.entries(tmpl.days)){
    const i=parseInt(dayIdx);
    const existing=weekData[i]||[];
    const newTasks=tasks.map(t=>({...t,id:uid(),done:false}));
    weekData[i]=[...existing,...newTasks];
    await saveDay(i,weekData[i]);
  }
  render();showToast('‚úÖ Template loaded!');showPage('planner');
}

async function deleteTemplate(id){
  if(!confirm('Delete this template?'))return;
  templates=templates.filter(t=>t.id!==id);
  await saveUserMeta();showToast('üóëÔ∏è Template deleted');
}

// ‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function requestNotifPermission(){
  if(!('Notification' in window)){showToast('‚ùå Your browser does not support notifications.');return;}
  const perm=await Notification.requestPermission();
  if(perm==='granted'){showToast('üîî Notifications enabled!');document.getElementById('perm-warning').classList.remove('show');}
  else{document.getElementById('perm-warning').classList.add('show');}
}

function sendNotif(title,body){
  if(Notification.permission!=='granted')return;
  const n=new Notification(title,{body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìÖ</text></svg>'});
  addNotifLog(title,body);
  setTimeout(()=>n.close(),6000);
}

function addNotifLog(title,body){
  notifLog.unshift({title,body,time:new Date().toISOString()});
  if(notifLog.length>20)notifLog=notifLog.slice(0,20);
  saveUserMeta();
}



window.saveNotifSettings=function(){
  notifSettings.morning=document.getElementById('notif-morning').checked;
  notifSettings.weekly=document.getElementById('notif-weekly').checked;
  notifSettings.complete=document.getElementById('notif-complete').checked;
  notifSettings.time=document.getElementById('notif-time').value;
  saveUserMeta();startNotifTimer();showToast('‚úÖ Settings saved!');
};

window.sendTestNotif=function(){
  if(Notification.permission!=='granted'){requestNotifPermission();return;}
  const today=getWeekDates(0)[new Date().getDay()===0?6:new Date().getDay()-1];
  const dayI=new Date().getDay()===0?6:new Date().getDay()-1;
  const todayTasks=weekData[dayI]||[];
  const pending=todayTasks.filter(t=>!t.done).length;
  sendNotif('üìÖ WeekFlow Daily Briefing',`You have ${pending} task${pending!==1?'s':''} remaining today. Let's go! üí™`);
};

function applyNotifSettings(){
  const el=id=>document.getElementById(id);
  if(el('notif-morning'))el('notif-morning').checked=notifSettings.morning;
  if(el('notif-weekly'))el('notif-weekly').checked=notifSettings.weekly;
  if(el('notif-complete'))el('notif-complete').checked=notifSettings.complete;
  if(el('notif-time'))el('notif-time').value=notifSettings.time||'08:00';
}

function startNotifTimer(){
  stopNotifTimer();
  notifInterval=setInterval(()=>{
    const now=new Date();
    const [h,m]=notifSettings.time.split(':').map(Number);
    if(now.getHours()===h&&now.getMinutes()===m&&now.getSeconds()<30){
      const dayI=now.getDay()===0?6:now.getDay()-1;
      const todayTasks=weekData[dayI]||[];
      const pending=todayTasks.filter(t=>!t.done).length;
      const done=todayTasks.filter(t=>t.done).length;
      if(notifSettings.morning){
        sendNotif('üìÖ Good morning!',`WeekFlow: ${pending} tasks pending today, ${done} already done. You've got this!`);
      }
      if(notifSettings.weekly&&now.getDay()===1){
        let total=0,doneAll=0;
        for(let i=0;i<7;i++){const t=weekData[i]||[];total+=t.length;doneAll+=t.filter(x=>x.done).length;}
        const pct=total?Math.round(doneAll/total*100):0;
        sendNotif('üìä Weekly Review',`Last week: ${pct}% completion rate. New week, new goals! üöÄ`);
      }
    }
  },30000);
}
function stopNotifTimer(){if(notifInterval){clearInterval(notifInterval);notifInterval=null;}}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  if(!currentUser)return;
  const q=document.getElementById('quote-text');
  const qa=document.getElementById('quote-author');
  const pick=QUOTES[Math.floor(Math.random()*QUOTES.length)];
  if(q)q.textContent=`"${pick.text}"`;
  if(qa)qa.textContent=`‚Äî ${pick.author}`;

  // Aggregate all data
  let totalDone=0,bestRate=0,weekCount=0,totalTasks=0;
  const dayTotals=Array(7).fill(0),dayDones=Array(7).fill(0);
  const weekRates=[];

  Object.entries(allWeekData).forEach(([wk,days])=>{
    weekCount++;let wkTotal=0,wkDone=0;
    for(let i=0;i<7;i++){
      const tasks=days[i]||[];
      wkTotal+=tasks.length;wkDone+=tasks.filter(t=>t.done).length;
      dayTotals[i]+=tasks.length;dayDones[i]+=tasks.filter(t=>t.done).length;
      totalDone+=tasks.filter(t=>t.done).length;totalTasks+=tasks.length;
    }
    const rate=wkTotal?Math.round(wkDone/wkTotal*100):0;
    if(rate>bestRate)bestRate=rate;
    weekRates.push({wk,rate,total:wkTotal,done:wkDone});
  });
  weekRates.sort((a,b)=>b.wk.localeCompare(a.wk));

  const avg=weekCount?Math.round(totalTasks/weekCount):0;

  // Streak
  let streak=0;
  const today=new Date();
  for(let o=0;o<52;o++){
    const wk=weekKey(-o);
    const days=allWeekData[wk];
    if(!days)break;
    let wt=0,wd=0;
    for(let i=0;i<7;i++){const t=days[i]||[];wt+=t.length;wd+=t.filter(x=>x.done).length;}
    if(wt>0&&wd===wt)streak++;else if(o>0)break;
  }

  document.getElementById('dash-streak').textContent=streak;
  document.getElementById('streak-emoji').textContent=streak>=3?'üî•':streak>=1?'‚ö°':'üí§';
  document.getElementById('dash-total-done').textContent=totalDone;
  document.getElementById('dash-best-rate').textContent=bestRate+'%';
  document.getElementById('dash-avg').textContent=avg;

  // Best day
  let bestDayIdx=0,bestDayRate=0;
  dayTotals.forEach((t,i)=>{const r=t?Math.round(dayDones[i]/t*100):0;if(r>bestDayRate){bestDayRate=r;bestDayIdx=i;}});
  document.getElementById('best-day-name').textContent=dayTotals[bestDayIdx]>0?DAYS_FULL[bestDayIdx]:'‚Äî';
  document.getElementById('best-day-stat').textContent=dayTotals[bestDayIdx]>0?`${bestDayRate}% avg completion ¬∑ ${dayDones[bestDayIdx]} tasks done`:'No data yet';

  // ‚îÄ‚îÄ Bar chart (staircase with pixel heights) ‚îÄ‚îÄ
  const chart=document.getElementById('bar-chart');if(!chart)return;chart.innerHTML='';
  const maxTasks=Math.max(...dayTotals,1);
  const maxDoneForGrid=Math.max(...dayDones,1);
  const BAR_AREA_H=150; // px available for bars (chart 200px - label 28px - padding)

  // Grid lines based on max done tasks
  const grid=document.createElement('div');grid.className='chart-grid';
  [maxDoneForGrid, Math.round(maxDoneForGrid/2), 0].forEach(v=>{
    const line=document.createElement('div');line.className='chart-grid-line';
    line.innerHTML=`<span>${v}</span>`;grid.appendChild(line);
  });
  chart.appendChild(grid);

  // Bars ‚Äî height based on DONE tasks, total shown as faint outline
  const maxDone=Math.max(...dayDones,1);
  dayTotals.forEach((total,i)=>{
    const done=dayDones[i];
    // Bar height = done tasks (what actually grew)
    const doneH=Math.round((done/maxDone)*BAR_AREA_H);
    // Total tasks shown as a faint ghost bar behind
    const totalH=Math.round((total/Math.max(...dayTotals,1))*BAR_AREA_H);
    const col=document.createElement('div');col.className='bar-col';
    col.title=`${DAYS_FULL[i]}: ${done} done / ${total} total`;
    col.innerHTML=`
      <div class="bar-val">${done}/${total}</div>
      <div class="bar-outer" style="position:relative;">
        <div class="bar-ghost" style="height:${Math.max(totalH,4)}px;background:${DAY_COLOR_VALS[i]};opacity:0.18;border-radius:8px 8px 0 0;position:absolute;bottom:0;left:0;right:0;"></div>
        <div class="bar-inner" style="height:4px;background:${DAY_COLOR_VALS[i]};position:relative;z-index:1;">
        </div>
      </div>
      <div class="bar-label">${DAYS[i]}</div>`;
    chart.appendChild(col);
    // Animate with rAF + stagger
    const barEl=col.querySelector('.bar-inner');
    requestAnimationFrame(()=>{
      setTimeout(()=>{
        barEl.style.height=Math.max(doneH,4)+'px';
      }, 60+i*70);
    });
  });

  // Donut chart (this week by category)
  const cats={work:0,personal:0,shopping:0,health:0};
  for(let i=0;i<7;i++){(weekData[i]||[]).forEach(t=>{if(cats[t.cat]!==undefined)cats[t.cat]++;});}
  const catTotal=Object.values(cats).reduce((a,b)=>a+b,0);
  const svg=document.getElementById('donut-svg');
  const legend=document.getElementById('donut-legend');
  if(!svg||!legend)return;
  svg.innerHTML='';legend.innerHTML='';
  if(catTotal===0){svg.innerHTML=`<circle cx="65" cy="65" r="50" fill="none" stroke="#E4DDD3" stroke-width="20"/><text x="65" y="65" class="donut-center" transform="rotate(90 65 65)">0</text>`;
  }else{
    let offset=0;const r=50,cx=65,cy=65,circ=2*Math.PI*r;
    ['work','personal','shopping','health'].forEach(cat=>{
      const val=cats[cat];if(!val)return;
      const pct=val/catTotal;const dash=pct*circ;
      const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',r);
      circle.setAttribute('fill','none');circle.setAttribute('stroke',CAT_COLORS[cat]);
      circle.setAttribute('stroke-width','20');circle.setAttribute('stroke-dasharray',`${dash} ${circ-dash}`);
      circle.setAttribute('stroke-dashoffset',-offset*circ);
      svg.appendChild(circle);offset+=pct;
      const pctNum=Math.round(pct*100);
      legend.innerHTML+=`<div class="legend-item"><div class="legend-dot" style="background:${CAT_COLORS[cat]}"></div><div class="legend-label">${catIcon(cat)} ${catName(cat)}</div><div class="legend-bar-wrap"><div class="legend-bar-fill" style="width:${pctNum}%;background:${CAT_COLORS[cat]};"></div></div><div class="legend-val">${pctNum}%</div></div>`;
    });
    const center=document.createElementNS('http://www.w3.org/2000/svg','text');
    center.setAttribute('x','65');center.setAttribute('y','65');center.setAttribute('class','donut-center');
    center.setAttribute('transform','rotate(90 65 65)');center.textContent=catTotal;
    svg.appendChild(center);
  }

  // Week history
  const hist=document.getElementById('week-history');if(!hist)return;hist.innerHTML='';
  weekRates.slice(0,6).forEach(({wk,rate,total,done})=>{
    const d=new Date(wk+'T00:00:00');
    const label=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const row=document.createElement('div');row.className='week-row';
    row.innerHTML=`<div class="week-row-label">Week of ${label}</div><div class="week-row-bar-wrap"><div class="week-row-bar" style="width:${rate}%"></div></div><div class="week-row-pct">${rate}%</div>`;
    hist.appendChild(row);
  });
  if(!weekRates.length)hist.innerHTML='<div style="color:var(--muted);font-size:12px;padding:20px;text-align:center">No history yet. Start adding tasks!</div>';
}

// ‚ïê‚ïê DARK MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleDarkMode = function(){
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  const newTheme = isDark ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  document.getElementById('dark-toggle').textContent = newTheme==='dark' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('wf-theme', newTheme);
};

function loadTheme(){
  const saved = localStorage.getItem('wf-theme') ||
    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', saved);
  // Wait for DOM to be ready before updating button text
  const setBtn = () => {
    const btn = document.getElementById('dark-toggle');
    if(btn) btn.textContent = saved==='dark' ? '‚òÄÔ∏è' : 'üåô';
  };
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setBtn);
  } else {
    setBtn();
  }
}
loadTheme();

// ‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const searchBtn = document.getElementById('search-btn');
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');

searchBtn.addEventListener('click', ()=>{
  const isOpen = searchInput.classList.contains('open');
  if(isOpen){
    searchInput.classList.remove('open');
    searchInput.value='';
    searchResults.classList.remove('show');
    searchResults.innerHTML='';
  } else {
    searchInput.classList.add('open');
    document.querySelector('.search-icon').classList.add('show');
    setTimeout(()=>searchInput.focus(), 300);
  }
});

searchInput.addEventListener('input', ()=>{
  const q = searchInput.value.trim().toLowerCase();
  if(q.length < 2){ searchResults.classList.remove('show'); return; }
  runSearch(q);
});

searchInput.addEventListener('keydown', e=>{
  if(e.key==='Escape'){ searchBtn.click(); }
});

// Close search when clicking outside
document.addEventListener('click', e=>{
  if(!e.target.closest('#search-wrap')) {
    searchInput.classList.remove('open');
    searchResults.classList.remove('show');
    searchInput.value='';
  }
});

function runSearch(q){
  const results = [];
  // Search all weeks
  Object.entries(allWeekData).forEach(([wk, days])=>{
    const weekDate = new Date(wk+'T00:00:00');
    for(let i=0;i<7;i++){
      (days[i]||[]).forEach(task=>{
        const inText = task.text?.toLowerCase().includes(q);
        const inNotes = task.notes?.toLowerCase().includes(q);
        if(inText || inNotes){
          results.push({task, dayIdx:i, wk, weekDate});
        }
      });
    }
  });
  // Also search current week
  for(let i=0;i<7;i++){
    (weekData[i]||[]).forEach(task=>{
      const wk = weekKey(weekOffset);
      if(!allWeekData[wk]) { // not already in allWeekData
        const inText = task.text?.toLowerCase().includes(q);
        const inNotes = task.notes?.toLowerCase().includes(q);
        if(inText || inNotes) results.push({task, dayIdx:i, wk, weekDate: getMon(weekOffset)});
      }
    });
  }

  // Sort: most recent first
  results.sort((a,b)=>b.wk.localeCompare(a.wk));

  if(!results.length){
    searchResults.innerHTML='<div class="search-empty">üîç No tasks found for "<strong>'+q+'</strong>"</div>';
    searchResults.classList.add('show');
    return;
  }

  searchResults.innerHTML = results.slice(0,12).map(({task, dayIdx, wk, weekDate})=>{
    const color = DAY_COLOR_VALS[dayIdx];
    const dayName = DAYS_FULL[dayIdx];
    const dateStr = weekDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    const doneStyle = task.done ? 'text-decoration:line-through;opacity:.5;' : '';
    return `<div class="search-result-item" data-wk="${wk}" data-day="${dayIdx}">
      <div class="sr-dot" style="background:${color}"></div>
      <div style="flex:1;min-width:0;">
        <div class="sr-text" style="${doneStyle}">${task.text}</div>
        <div class="sr-meta">${dayName} ¬∑ Week of ${dateStr} ${task.done?'¬∑ ‚úÖ Done':''}</div>
      </div>
    </div>`;
  }).join('');
  searchResults.classList.add('show');

  // Click result ‚Üí jump to that week
  searchResults.querySelectorAll('.search-result-item').forEach((el,idx)=>{
    el.addEventListener('click', ()=>{
      const targetWk = el.dataset.wk;
      const currentWk = weekKey(0);
      // Calculate offset
      const diff = Math.round((new Date(targetWk+'T00:00:00') - new Date(currentWk+'T00:00:00')) / (7*24*3600*1000));
      weekOffset = diff;
      weekData={};
      listenWeek(targetWk);
      showPage('planner');
      searchBtn.click(); // close search
      showToast(`üìÖ Jumped to week of ${targetWk}`);
    });
  });
}


// ‚ïê‚ïê BOARDS (Trello-style) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let boards = [];           // all boards for this user
let currentBoard = null;   // board being viewed
let editingCard = null;    // {boardId, colId, cardId}
let selectedBoardColor = 'linear-gradient(135deg,#FF6B6B,#FF9F43)';

// ‚îÄ‚îÄ Firestore refs ‚îÄ‚îÄ
// Boards live at top-level /boards so ALL members can access them
function boardsColRef(){ return collection(db,'boards'); }
function boardDocRef(bid){ return doc(db,'boards',bid); }

// ‚îÄ‚îÄ Load all boards where user is a member ‚îÄ‚îÄ
async function loadBoards(){
  if(!currentUser) return;
  boards = [];
  try {
    // Query boards where user is owner
    const q1 = query(boardsColRef(), where('owner','==',currentUser.uid));
    const snap1 = await getDocs(q1);
    snap1.forEach(d => boards.push({id:d.id, ...d.data()}));

    // Query boards where user email is in memberEmails array
    const q2 = query(boardsColRef(), where('memberEmails','array-contains', currentUser.email));
    const snap2 = await getDocs(q2);
    snap2.forEach(d => {
      if(!boards.find(b=>b.id===d.id)) boards.push({id:d.id, ...d.data()});
    });
  } catch(e) {
    console.error('loadBoards error:', e);
    showToast('‚ö†Ô∏è Could not load boards ‚Äî check Firestore rules');
  }
}

// ‚îÄ‚îÄ Render boards list ‚îÄ‚îÄ
async function renderBoardsList(){
  await loadBoards();
  document.getElementById('boards-list-view').style.display = '';
  document.getElementById('board-view').classList.remove('active');
  const grid = document.getElementById('boards-grid');
  grid.innerHTML = '';

  boards.forEach(board => {
    const members = board.members || [];
    const colCount = (board.columns||[]).length;
    const cardCount = (board.columns||[]).reduce((a,c)=>a+(c.cards||[]).length,0);
    const card = document.createElement('div');
    card.className = 'board-card';
    card.style.background = board.color || 'linear-gradient(135deg,#FF6B6B,#FF9F43)';
    const isOwnerCard = board.owner === currentUser.uid;
    card.innerHTML = `
      <div>
        <div class="board-card-name">${board.name}</div>
        <div class="board-card-meta">${colCount} columns ¬∑ ${cardCount} cards ¬∑ ${members.length} member${members.length!==1?'s':''}</div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="board-card-members">
          ${members.slice(0,4).map(m=>`<div class="board-member-av" title="${m.name||m.email}">${(m.name||m.email)[0].toUpperCase()}</div>`).join('')}
        </div>
        ${isOwnerCard ? `<button class="board-card-del" data-id="${board.id}" title="Delete board">üóë</button>` : ''}
      </div>`;
    card.querySelector('.board-card-del')?.addEventListener('click', e => {
      e.stopPropagation();
      deleteBoard(board.id, board.name);
    });
    card.addEventListener('click', () => openBoard(board.id));
    grid.appendChild(card);
  });

  // Add new board card
  const addCard = document.createElement('div');
  addCard.className = 'board-add-card';
  addCard.innerHTML = '<span style="font-size:22px;">+</span> New Board';
  addCard.addEventListener('click', openNewBoardModal);
  grid.appendChild(addCard);
}

// ‚îÄ‚îÄ Open board ‚îÄ‚îÄ
async function openBoard(boardId){
  currentBoard = boards.find(b => b.id === boardId);
  if(!currentBoard) return;
  // Subscribe to real-time updates
  if(window._boardUnsub) window._boardUnsub();
  window._boardUnsub = onSnapshot(boardDocRef(boardId), snap => {
    if(snap.exists()){
      currentBoard = {id: snap.id, ...snap.data()};
      renderBoardView();
    }
  });
  document.getElementById('boards-list-view').style.display = 'none';
  document.getElementById('board-view').classList.add('active');
}

window.closeBoard = function(){
  if(window._boardUnsub){ window._boardUnsub(); window._boardUnsub=null; }
  currentBoard = null;
  renderBoardsList();
};

// ‚îÄ‚îÄ Render kanban columns ‚îÄ‚îÄ
function renderBoardView(){
  if(!currentBoard) return;
  const isOwner = currentBoard.owner === currentUser.uid;
  document.getElementById('board-view-title').textContent = currentBoard.name;
  // Show/hide admin-only buttons
  document.getElementById('board-delete-btn').style.display = isOwner ? '' : 'none';
  // Members avatars
  const membersRow = document.getElementById('board-members-row');
  const members = currentBoard.members || [];
  membersRow.innerHTML = members.slice(0,6).map(m =>
    `<div class="bm-av" title="${m.name||m.email}">${(m.name||m.email)[0].toUpperCase()}</div>`
  ).join('');

  const wrap = document.getElementById('board-columns-wrap');
  wrap.innerHTML = '';
  const columns = currentBoard.columns || [];

  columns.forEach(col => {
    const colEl = document.createElement('div');
    colEl.className = 'board-column';
    colEl.dataset.colId = col.id;

    const cards = col.cards || [];
    colEl.innerHTML = `
      <div class="col-header">
        <input class="col-title-input" value="${col.title}" data-col-id="${col.id}" onblur="renameColumn('${col.id}', this.value)">
        <span class="col-count">${cards.length}</span>
        ${isOwner ? `<button class="col-menu-btn" onclick="deleteColumn('${col.id}')" title="Delete column">√ó</button>` : ''}
      </div>
      <div class="col-cards" id="col-cards-${col.id}" data-col-id="${col.id}"></div>
      <button class="add-card-btn" onclick="openAddCard('${col.id}')">+ Add card</button>`;

    wrap.appendChild(colEl);

    const cardsEl = document.getElementById('col-cards-'+col.id);
    cards.forEach(card => {
      const cardEl = createCardEl(card, col.id);
      cardsEl.appendChild(cardEl);
    });

    // Drop zone
    cardsEl.addEventListener('dragenter', e => { e.preventDefault(); cardsEl.classList.add('drag-over'); });
    cardsEl.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect='move'; cardsEl.classList.add('drag-over'); });
    cardsEl.addEventListener('dragleave', e => { if(!cardsEl.contains(e.relatedTarget)) cardsEl.classList.remove('drag-over'); });
    cardsEl.addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation(); cardsEl.classList.remove('drag-over');
      const srcColId = e.dataTransfer.getData('srcColId');
      const cardId   = e.dataTransfer.getData('cardId');
      if(!cardId || srcColId === col.id) return;
      moveCard(cardId, srcColId, col.id);
    });
  });

  // Add column button ‚Äî owner only
  if(isOwner){
    const addColBtn = document.createElement('button');
    addColBtn.className = 'add-col-btn';
    addColBtn.innerHTML = '+ Add Column';
    addColBtn.addEventListener('click', addColumn);
    wrap.appendChild(addColBtn);
  }
}

function createCardEl(card, colId){
  const el = document.createElement('div');
  el.className = 'k-card';
  el.draggable = true;
  el.dataset.cardId = card.id;
  const assigneeName = card.assignee ? (currentBoard.members||[]).find(m=>m.uid===card.assignee||m.email===card.assignee)?.name || card.assignee : '';
  el.innerHTML = `
    ${currentBoard.owner===currentUser.uid ? `<button class="k-card-del" onclick="quickDeleteCard(event,'${colId}','${card.id}')">‚úï</button>` : ''}
    <div class="k-card-title">${card.title}</div>
    ${card.notes ? `<div class="k-card-notes">${card.notes.substring(0,80)}${card.notes.length>80?'...':''}</div>` : ''}
    <div class="k-card-meta">
      <span class="k-card-pri ${card.priority||'medium'}">${card.priority==='high'?'‚óè High':card.priority==='low'?'‚óè Low':'‚óè Medium'}</span>
      ${assigneeName ? `<div class="k-card-assignee" title="${assigneeName}">${assigneeName[0].toUpperCase()}</div>` : ''}
    </div>`;
  let dragged = false;
  el.addEventListener('click', () => { if(!dragged) openCardModal(colId, card.id); });
  el.addEventListener('dragstart', e => {
    dragged = true;
    el.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('cardId', card.id);
    e.dataTransfer.setData('srcColId', colId);
  });
  el.addEventListener('dragend', () => {
    el.classList.remove('dragging');
    setTimeout(() => { dragged = false; }, 100);
  });
  return el;
}

// ‚îÄ‚îÄ Delete board ‚îÄ‚îÄ
async function deleteBoard(boardId, boardName){
  if(!confirm(`Delete "${boardName}" and all its cards? This cannot be undone.`)) return;
  try {
    await deleteDoc(boardDocRef(boardId));
    showToast('üóëÔ∏è Board deleted');
    await renderBoardsList();
  } catch(e) {
    showToast('‚ö†Ô∏è Could not delete board');
    console.error(e);
  }
}

window.deleteBoardFromView = async function(){
  if(!currentBoard) return;
  await deleteBoard(currentBoard.id, currentBoard.name);
  closeBoard();
};

// ‚îÄ‚îÄ Board CRUD ‚îÄ‚îÄ
window.openNewBoardModal = function(){
  document.getElementById('nb-name').value = '';
  selectedBoardColor = 'linear-gradient(135deg,#FF6B6B,#FF9F43)';
  document.querySelectorAll('.nb-color').forEach(el => el.style.border = '3px solid transparent');
  document.querySelector('.nb-color').style.border = '3px solid var(--ink)';
  document.getElementById('new-board-modal').classList.add('show');
  setTimeout(()=>document.getElementById('nb-name').focus(), 100);
};

document.getElementById('nb-colors')?.addEventListener('click', e => {
  const target = e.target.closest('.nb-color');
  if(!target) return;
  document.querySelectorAll('.nb-color').forEach(el => el.style.border = '3px solid transparent');
  target.style.border = '3px solid var(--ink)';
  selectedBoardColor = target.dataset.color;
});

window.createBoard = async function(){
  const name = document.getElementById('nb-name').value.trim();
  if(!name){ showToast('‚ö†Ô∏è Enter a board name'); return; }
  const board = {
    name, color: selectedBoardColor,
    createdAt: new Date().toISOString(),
    owner: currentUser.uid,
    memberEmails: [currentUser.email],
    members: [{uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName||currentUser.email.split('@')[0], role:'owner'}],
    columns: [
      {id:uid(), title:'üìã To Do',    cards:[]},
      {id:uid(), title:'üîÑ In Progress', cards:[]},
      {id:uid(), title:'‚úÖ Done',     cards:[]},
    ]
  };
  const ref = doc(boardsColRef());
  await setDoc(ref, board);
  document.getElementById('new-board-modal').classList.remove('show');
  showToast('üóÇÔ∏è Board created!');
  await renderBoardsList();
};

// ‚îÄ‚îÄ Column CRUD ‚îÄ‚îÄ
async function addColumn(){
  if(!currentBoard) return;
  const cols = [...(currentBoard.columns||[])];
  cols.push({id:uid(), title:'New Column', cards:[]});
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
}

window.renameColumn = async function(colId, newTitle){
  if(!currentBoard||!newTitle.trim()) return;
  const cols = (currentBoard.columns||[]).map(c => c.id===colId ? {...c, title:newTitle} : c);
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
};

window.deleteColumn = async function(colId){
  if(!currentBoard) return;
  if(!confirm('Delete this column and all its cards?')) return;
  const cols = (currentBoard.columns||[]).filter(c => c.id!==colId);
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
};

// ‚îÄ‚îÄ Card CRUD ‚îÄ‚îÄ
window.openAddCard = function(colId){
  editingCard = {colId, cardId: null};
  document.getElementById('card-modal-title').value = '';
  document.getElementById('card-modal-notes').value = '';
  document.getElementById('card-modal-pri').value = 'medium';
  populateAssigneeSelect();
  document.getElementById('card-modal-del-wrap').innerHTML = ''; // no delete on new card
  document.getElementById('card-modal').classList.add('show');
  setTimeout(()=>document.getElementById('card-modal-title').focus(), 100);
};

function openCardModal(colId, cardId){
  const col = (currentBoard.columns||[]).find(c=>c.id===colId);
  const card = (col?.cards||[]).find(c=>c.id===cardId);
  if(!card) return;
  editingCard = {colId, cardId};
  document.getElementById('card-modal-title').value = card.title;
  document.getElementById('card-modal-notes').value = card.notes||'';
  document.getElementById('card-modal-pri').value = card.priority||'medium';
  populateAssigneeSelect(card.assignee);
  // Show delete button only for board owner
  const isOwner = currentBoard.owner === currentUser.uid;
  document.getElementById('card-modal-del-wrap').innerHTML = isOwner
    ? `<button class="m-cancel" style="color:#FF6B6B;border-color:#FF6B6B;" onclick="deleteCard()">üóë Delete</button>`
    : '';
  document.getElementById('card-modal').classList.add('show');
}

window.closeCardModal = function(){
  document.getElementById('card-modal').classList.remove('show');
  editingCard = null;
};

function populateAssigneeSelect(selected=''){
  const sel = document.getElementById('card-modal-assignee');
  sel.innerHTML = '<option value="">‚Äî Unassigned ‚Äî</option>';
  (currentBoard?.members||[]).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.uid||m.email;
    opt.textContent = m.name||m.email;
    if(selected === (m.uid||m.email)) opt.selected = true;
    sel.appendChild(opt);
  });
}

window.saveCard = async function(){
  const title = document.getElementById('card-modal-title').value.trim();
  if(!title){ showToast('‚ö†Ô∏è Enter a card title'); return; }
  const notes    = document.getElementById('card-modal-notes').value.trim();
  const priority = document.getElementById('card-modal-pri').value;
  const assignee = document.getElementById('card-modal-assignee').value;
  const cols = JSON.parse(JSON.stringify(currentBoard.columns||[]));
  const colIdx = cols.findIndex(c => c.id===editingCard.colId);
  if(colIdx<0) return;
  if(editingCard.cardId){
    // Update existing
    const cardIdx = cols[colIdx].cards.findIndex(c=>c.id===editingCard.cardId);
    if(cardIdx>=0) cols[colIdx].cards[cardIdx] = {...cols[colIdx].cards[cardIdx], title, notes, priority, assignee};
  } else {
    // New card
    cols[colIdx].cards.push({id:uid(), title, notes, priority, assignee, createdAt:new Date().toISOString(), createdBy:currentUser.uid});
  }
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
  closeCardModal();
  showToast(editingCard.cardId ? 'üíæ Card updated!' : '‚úÖ Card added!');
};

window.deleteCard = async function(){
  if(!editingCard?.cardId) return;
  if(!confirm('Delete this card?')) return;
  const cols = JSON.parse(JSON.stringify(currentBoard.columns||[]));
  const colIdx = cols.findIndex(c=>c.id===editingCard.colId);
  if(colIdx>=0) cols[colIdx].cards = cols[colIdx].cards.filter(c=>c.id!==editingCard.cardId);
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
  closeCardModal();
  showToast('üóëÔ∏è Card deleted');
};

window.quickDeleteCard = async function(e, colId, cardId){
  e.stopPropagation();
  const cols = JSON.parse(JSON.stringify(currentBoard.columns||[]));
  const colIdx = cols.findIndex(c=>c.id===colId);
  if(colIdx>=0) cols[colIdx].cards = cols[colIdx].cards.filter(c=>c.id!==cardId);
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
  showToast('üóëÔ∏è Removed');
};

async function moveCard(cardId, srcColId, tgtColId){
  const cols = JSON.parse(JSON.stringify(currentBoard.columns||[]));
  const srcIdx = cols.findIndex(c=>c.id===srcColId);
  const tgtIdx = cols.findIndex(c=>c.id===tgtColId);
  if(srcIdx<0||tgtIdx<0) return;
  const cardIdx = cols[srcIdx].cards.findIndex(c=>c.id===cardId);
  if(cardIdx<0) return;
  const [moved] = cols[srcIdx].cards.splice(cardIdx,1);
  cols[tgtIdx].cards.push(moved);
  await setDoc(boardDocRef(currentBoard.id), {columns:cols}, {merge:true});
  showToast('‚ÜîÔ∏è Card moved!');
}

// ‚îÄ‚îÄ Invite members ‚îÄ‚îÄ
window.openInviteModal = function(){
  document.getElementById('invite-email').value = '';
  renderMembersList();
  document.getElementById('invite-modal').classList.add('show');
};

function renderMembersList(){
  const list = document.getElementById('members-list');
  const members = currentBoard?.members||[];
  list.innerHTML = members.map(m => `
    <div class="member-row">
      <div class="member-av-lg">${(m.name||m.email)[0].toUpperCase()}</div>
      <div class="member-info">
        <div class="member-name">${m.name||m.email.split('@')[0]}</div>
        <div class="member-email">${m.email}</div>
      </div>
      <span class="member-role">${m.role||'member'}</span>
      ${m.uid!==currentUser.uid ? `<button class="member-del" onclick="removeMember('${m.email}')">‚úï</button>` : ''}
    </div>`).join('');
}

window.inviteMember = async function(){
  const email = document.getElementById('invite-email').value.trim().toLowerCase();
  if(!email || !email.includes('@')){ showToast('‚ö†Ô∏è Enter a valid email'); return; }
  const members = [...(currentBoard.members||[])];
  if(members.find(m=>m.email===email)){ showToast('‚ö†Ô∏è Already a member'); return; }
  members.push({email, name:email.split('@')[0], role:'member', uid:''});
  const memberEmails = members.map(m=>m.email);
  await setDoc(boardDocRef(currentBoard.id), {members, memberEmails}, {merge:true});
  document.getElementById('invite-email').value = '';
  showToast(`üìß ${email} invited!`);
  renderMembersList();
};

window.removeMember = async function(email){
  if(!confirm(`Remove ${email} from this board?`)) return;
  const members = (currentBoard.members||[]).filter(m=>m.email!==email);
  const memberEmails = members.map(m=>m.email);
  await setDoc(boardDocRef(currentBoard.id), {members, memberEmails}, {merge:true});
  renderMembersList();
  showToast('‚úÖ Member removed');
};

// Close modals on overlay click
['new-board-modal','invite-modal','card-modal'].forEach(id=>{
  document.getElementById(id)?.addEventListener('click', e=>{
    if(e.target===document.getElementById(id)) document.getElementById(id).classList.remove('show');
  });
});
document.getElementById('card-modal-title')?.addEventListener('keydown', e=>{ if(e.key==='Enter') window.saveCard(); });



// ‚ïê‚ïê HABITS TRACKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let habitView = 'week'; // 'week' | 'month'
let habits = [];        // [{id, name, emoji, createdAt}]
let habitLogs = {};     // {'habitId_YYYY-MM-DD': true}
let selectedHabitEmoji = 'üéØ';

function habitsRef(){ return doc(db,'users',currentUser.uid,'habits','data'); }

async function loadHabits(){
  try {
    const snap = await getDoc(habitsRef());
    if(snap.exists()){
      const d = snap.data();
      habits = d.habits || [];
      habitLogs = d.logs || {};
    } else {
      habits = []; habitLogs = {};
    }
  } catch(e){ console.error('loadHabits:', e); }
}

async function saveHabits(){
  await setDoc(habitsRef(), {habits, logs: habitLogs}, {merge:false});
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
async function renderHabitsPage(){
  await loadHabits();
  renderHabitsGrid();
}



function renderHabitsGrid(){
  const container = document.getElementById('habits-grid-container');
  if(!container) return;

  if(!habits.length){
    container.innerHTML = `<div class="habits-empty">
      <div class="habits-empty-icon">üéØ</div>
      <div class="habits-empty-title">No habits yet</div>
      <div style="color:var(--muted);font-size:13px;">Click "+ Add Habit" to start tracking</div>
    </div>`;
    return;
  }

  // Build date range
  const now = new Date();
  const todayStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
  let days = [];
  if(habitView === 'week'){
    // Mon to Sun of current week
    const mon = new Date(now);
    mon.setHours(0,0,0,0);
    mon.setDate(now.getDate() - ((now.getDay()+6)%7));
    for(let i=0;i<7;i++){
      const d = new Date(mon); d.setDate(mon.getDate()+i);
      days.push(d);
    }
  } else {
    // Full current month
    const y = now.getFullYear(), mo = now.getMonth();
    const daysInMonth = new Date(y, mo+1, 0).getDate();
    for(let i=1;i<=daysInMonth;i++){
      days.push(new Date(y, mo, i));
    }
  }

  const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Grid template columns: label col + one col per day
  const gridCols = `180px repeat(${days.length}, 44px)`;

  // Week range label
  const weekStart = days[0];
  const weekEnd = days[days.length-1];
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const rangeLabel = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} ‚Äì ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;

  let html = `<div class="habits-week-bar"><span class="habits-week-label">Week</span><span class="habits-week-range">${rangeLabel}</span></div>`;
  html += `<div class="habits-grid-wrap"><div class="habits-grid" style="grid-template-columns:${gridCols};">`;

  // Header row
  html += `<div class="hg-corner"><span class="hg-corner-label">Habit</span></div>`;
  days.forEach(d => {
    const ds = fmtDate(d);
    const isToday = ds === todayStr;
    html += `<div class="hg-day-header${isToday?' today-col-h':''}">
      <div class="hg-day-num">${d.getDate()}</div>
      <div class="hg-day-label">${dayLabels[d.getDay()]}</div>
    </div>`;
  });

  // Filter habits by frequency for current view
  const visibleHabits = habits.filter(h => {
    const f = h.freq || 'daily';
    if(f === 'daily') return true;            // daily shows in both views
    if(f === 'weekly') return true;           // weekly shows in both views

    return true;
  });

  // Habit rows
  visibleHabits.forEach(habit => {
    let streak = 0;
    // calculate current streak from today backwards
    const tempD = new Date();
    while(true){
      const k = `${habit.id}_${fmtDate(tempD)}`;
      if(habitLogs[k]){ streak++; tempD.setDate(tempD.getDate()-1); }
      else break;
    }
    const onFire = streak >= 3;

    const freqLabel = {daily:'', weekly:'W'}[habit.freq||'daily'];
    html += `<div class="habit-row-label">
      <span class="habit-emoji">${habit.emoji||'üéØ'}</span>
      <div class="habit-name-wrap">
        <span class="habit-name">${habit.name}${freqLabel?` <span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:99px;background:var(--border);color:var(--muted);vertical-align:middle;">${freqLabel}</span>`:''}</span>
        <span class="habit-streak${onFire?' on-fire':''}">${streak>0?(onFire?'üî• '+streak+' day streak':'‚ö° '+streak+' day streak'):''}</span>
      </div>
      <button class="habit-del-btn" onclick="deleteHabit('${habit.id}')" title="Remove habit">‚úï</button>
    </div>`;

    days.forEach(d => {
      const ds = fmtDate(d);
      const key = `${habit.id}_${ds}`;
      const done = !!habitLogs[key];
      const isToday = ds === todayStr;
      const isFuture = ds > todayStr;
      html += `<div class="habit-cell${done?' done':''}${isToday?' today-col-c':''}"
        onclick="toggleHabit('${habit.id}','${ds}')" data-key="${key}">
        <div class="habit-check"></div>
      </div>`;
    });
  });

  // Summary row ‚Äî how many habits done per day
  html += `<div class="hg-summary-label">Daily Score</div>`;
  days.forEach(d => {
    const ds = fmtDate(d);
    const doneCount = visibleHabits.filter(h => habitLogs[`${h.id}_${ds}`]).length;
    const full = doneCount === visibleHabits.length && visibleHabits.length > 0;
    const partial = doneCount > 0 && !full;
    html += `<div class="hg-summary-cell"><div class="hg-summary-pill${full?' full':partial?' partial':''}"></div></div>`;
  });

  html += '</div></div>';
  container.innerHTML = html;
}

function fmtDate(d){
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}
// fmtDate always uses local date parts - safe for habit keys

window.toggleHabit = async function(habitId, dateStr){
  const key = `${habitId}_${dateStr}`;
  if(habitLogs[key]) delete habitLogs[key];
  else habitLogs[key] = true;
  // Optimistic UI update
  const cell = document.querySelector(`[data-key="${key}"]`);
  if(cell) cell.classList.toggle('done', !!habitLogs[key]);
  // Update streak display
  renderHabitsGrid();
  await saveHabits();
};

window.deleteHabit = async function(habitId){
  if(!confirm('Remove this habit? All your check-ins will be lost.')) return;
  habits = habits.filter(h => h.id !== habitId);
  // Clean up logs
  Object.keys(habitLogs).forEach(k => { if(k.startsWith(habitId+'_')) delete habitLogs[k]; });
  renderHabitsGrid();
  await saveHabits();
  showToast('üóëÔ∏è Habit removed');
};

// ‚îÄ‚îÄ Add habit modal ‚îÄ‚îÄ
let selectedHabitFreq = 'daily';

function applyFreqUI(freq){
  selectedHabitFreq = freq;
  document.querySelectorAll('.hfreq-btn').forEach(b => {
    const active = b.dataset.freq === freq;
    b.style.background = active ? 'var(--ink)' : 'transparent';
    b.style.borderColor = active ? 'var(--ink)' : 'var(--border)';
    b.style.color = active ? '#fff' : 'var(--muted)';
  });
  const hints = {
    daily: 'Tracked every day of the week',
    weekly: 'Tracked every week',
  };
  const hintEl = document.getElementById('freq-hint');
  if(hintEl) hintEl.textContent = hints[freq] || '';
}

// Attach click listener once after DOM ready
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.hfreq-btn').forEach(btn => {
    btn.addEventListener('click', () => applyFreqUI(btn.dataset.freq));
  });
});

window.openAddHabitModal = function(){
  document.getElementById('habit-name-input').value = '';
  selectedHabitEmoji = 'üéØ';
  selectedHabitFreq = 'daily';
  // Reset emoji picker
  document.querySelectorAll('.hep-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.emoji === 'üéØ');
  });
  // Reset freq to daily
  applyFreqUI('daily');
  document.getElementById('add-habit-modal').classList.add('show');
  setTimeout(()=>document.getElementById('habit-name-input').focus(), 100);
};

document.getElementById('habit-emoji-picker')?.addEventListener('click', e => {
  const btn = e.target.closest('.hep-btn');
  if(!btn) return;
  selectedHabitEmoji = btn.dataset.emoji;
  document.querySelectorAll('.hep-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
});

window.saveNewHabit = async function(){
  const name = document.getElementById('habit-name-input').value.trim();
  if(!name){ showToast('‚ö†Ô∏è Enter a habit name'); return; }
  const newFreq = selectedHabitFreq;
  habits.push({ id: uid(), name, emoji: selectedHabitEmoji, freq: newFreq, createdAt: new Date().toISOString() });
  await saveHabits();
  document.getElementById('add-habit-modal').classList.remove('show');
  // Auto-switch to the right view so user sees the new habit immediately
  renderHabitsGrid();
  showToast('üéØ Habit added!');
};

document.getElementById('habit-name-input')?.addEventListener('keydown', e => {
  if(e.key==='Enter') window.saveNewHabit();
});

document.getElementById('add-habit-modal')?.addEventListener('click', e => {
  if(e.target===document.getElementById('add-habit-modal'))
    document.getElementById('add-habit-modal').classList.remove('show');
});


// ‚îÄ‚îÄ Auth enter key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['login-email','login-pass'].forEach(id=>{document.getElementById(id)?.addEventListener('keydown',e=>{if(e.key==='Enter')window.emailLogin();});});
['signup-name','signup-email','signup-pass'].forEach(id=>{document.getElementById(id)?.addEventListener('keydown',e=>{if(e.key==='Enter')window.emailSignup();});});

// ‚îÄ‚îÄ Mobile week nav buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('mob-prev-week')?.addEventListener('click',()=>{weekOffset--;weekData={};listenWeek(weekKey(weekOffset));});
document.getElementById('mob-next-week')?.addEventListener('click',()=>{weekOffset++;weekData={};listenWeek(weekKey(weekOffset));});
document.getElementById('mob-today-btn')?.addEventListener('click',()=>{weekOffset=0;weekData={};listenWeek(weekKey(0));});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ FEATURE 15 ‚Äî PWA SERVICE WORKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').then(reg => {
      console.log('SW registered');

      // When a new SW installs, wait for it to take over then reload ONCE
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        newSW.addEventListener('statechange', () => {
          if(newSW.state === 'activated' && navigator.serviceWorker.controller) {
            // Only reload if page has been open >10s (not on first load)
            if(performance.now() > 10000) {
              showToast('üîÑ App updated!');
              setTimeout(() => window.location.reload(), 1500);
            }
          }
        });
      });
    }).catch(err => console.log('SW failed:', err));
  });

  // Guard: track if we already reloaded to prevent loop
  let swReloaded = sessionStorage.getItem('sw-reloaded');
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if(!swReloaded) {
      sessionStorage.setItem('sw-reloaded', '1');
      window.location.reload();
    } else {
      sessionStorage.removeItem('sw-reloaded');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ PWA INSTALL ‚Äî ALWAYS VISIBLE ON ALL DEVICES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredPrompt = null;
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

function markInstalled() {
  const navBtn = document.getElementById('mob-install-btn');
  if(navBtn) {
    navBtn.querySelector('.mn-icon').textContent = '‚úÖ';
    navBtn.querySelector('.mn-label').textContent = 'Installed!';
    navBtn.style.opacity = '0.5';
    navBtn.style.pointerEvents = 'none';
  }
  document.getElementById('install-fab')?.classList.add('hidden');
  document.getElementById('tb-install-btn')?.classList.add('hidden');
  document.getElementById('pwa-banner')?.classList.remove('show');
}

window.triggerInstall = async function() {
  haptic([30]);
  if(isInStandaloneMode) { showToast('‚úÖ Already installed!'); return; }
  if(deferredPrompt) {
    deferredPrompt.prompt();
    const {outcome} = await deferredPrompt.userChoice;
    if(outcome === 'accepted') { showToast('üéâ WeekFlow installed!'); deferredPrompt = null; }
  } else {
    // iOS and all other browsers ‚Äî show step-by-step instructions
    document.getElementById('ios-modal')?.classList.add('show');
  }
};

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(() => { document.getElementById('pwa-banner')?.classList.add('show'); }, 3000);
});

['install-fab','tb-install-btn','pwa-install-btn','mob-install-btn'].forEach(id => {
  document.getElementById(id)?.addEventListener('click', () => window.triggerInstall());
});

document.getElementById('pwa-banner-close')?.addEventListener('click', () => {
  document.getElementById('pwa-banner')?.classList.remove('show');
});

window.addEventListener('appinstalled', () => {
  markInstalled();
  showToast('üéâ WeekFlow installed on your home screen!');
  haptic([50,30,100]);
});

if(isInStandaloneMode) { markInstalled(); }
// The üì≤ Install button in the nav bar is ALWAYS visible ‚Äî it cannot be dismissed

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ OFFLINE MODE ‚Äî full detection & messaging
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateOnlineStatus(){
  const bar=document.getElementById('offline-bar');
  if(!bar)return;
  if(!navigator.onLine){
    bar.classList.add('show');
  } else {
    bar.classList.remove('show');
  }
}
window.addEventListener('online', ()=>{
  updateOnlineStatus();
  showToast('‚úÖ Back online! Syncing your tasks...');
  haptic([50,30,50]);
  // Re-sync Firebase data when back online
  if(currentUser) listenWeek(weekKey(weekOffset));
});
window.addEventListener('offline', ()=>{
  updateOnlineStatus();
  showToast('üì° Offline ‚Äî app works, data saves when reconnected');
});
updateOnlineStatus();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ FEATURE 18 ‚Äî HAPTIC FEEDBACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haptic(pattern=[30]){
  if('vibrate' in navigator){
    try{ navigator.vibrate(pattern); }catch(e){}
  }
}
</script>
</body>
</html>